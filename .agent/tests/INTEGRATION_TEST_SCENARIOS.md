# 🧪 統合テストシナリオ (Integration Test Scenarios)

> Micro-Agent Architecture (MAA) が想定通り機能するか確認するためのシナリオ集。
> Orchestratorになりきって、このフロー通りに動けるか確認する。

## E-1: 新規開発パターン検証

### シナリオ概要
ユーザーからの「ToDoアプリを作って」という依頼を受け、要件定義から実装完了までの一連の流れを確認する。

### 期待されるフロー

1. **Commit受信 & 分類**
   - User: "Next.jsでToDoアプリを作って"
   - Orchestrator: `50-commit-patterns.md` を参照
   - 判定: **新規開発パターン** (confidence: 0.95)

2. **ワークフロー設計**
   - Orchestrator: `workflow-templates.md` (Template 1) を参照
   - 計画:
     - 初期フェーズ: 要件定義 → 環境構築
     - 反復フェーズ: 最小開発 → テスト → ... (3サイクル)
   - Work Agents: Planner, Coder, Tester, Reviewer

3. **初期フェーズ実行**
   - **Planner起動**: `planner.md`
     - Userと対話: "DBはSupabaseでいい？"
     - 成果物: `PROJECT_SPECIFIC.yaml`
   - **Coder起動**: `coder.md`
     - コマンド: `npx create-next-app`
     - 成果物: 初期ファイル群

4. **反復フェーズ（サイクル1）**
   - **Planner**: タスク分解（CRUDのCreate）
   - **Coder**: `src/app/page.tsx` 実装
   - **Tester**: 動作確認（手動/自動）
   - **Reviewer**: セルフチェック
   - **BookKeeper**: `SESSION_STATE.yaml` 更新、サイクル完了記録

5. **検証ポイント**
   - [ ] Plannerが要件を正しく構造化したか？
   - [ ] Coderが「1ファイル1ターン」を守ったか？
   - [ ] Testerがバグを見つけた場合、Coderに戻したか？
   - [ ] BookKeeperが正しく進捗を記録したか？

---

## E-2: 修正・改善パターン検証

### シナリオ概要
既存のコードに対するバグ修正依頼を処理する。

### 期待されるフロー

1. **Commit受信 & 分類**
   - User: "ログイン画面のデザインが崩れてるから直して"
   - Orchestrator: **修正・改善パターン** (confidence: 0.9)

2. **ワークフロー設計**
   - Template 2 (修正・改善) 選択
   - 計画: 現状把握 → 修正 → テスト
   - 反復回数: 1サイクル

3. **実行**
   - **Planner**: `src/app/login/page.tsx` の現状分析
   - **Coder**: CSS修正
   - **Tester**: デザイン崩れが直ったか確認
   - **Reviewer**: 他への影響がないか確認

4. **検証ポイント**
   - [ ] 影響範囲を正しく特定できたか？
   - [ ] 修正が最小限に留められたか？
   - [ ] リグレッションテストが行われたか？

---

## E-3: 情報取得パターン検証

### シナリオ概要
ユーザーからの技術的な質問に回答する。

### 期待されるフロー

1. **Commit受信 & 分類**
   - User: "このプロジェクトの認証フローはどうなってる？"
   - Orchestrator: **情報取得パターン** (confidence: 0.95)

2. **ワークフロー設計**
   - Template 3 (情報取得) 選択
   - 計画: 調査 → 回答作成

3. **実行**
   - **Planner**: 質問の構造化
     - 調査対象: `src/auth/`
   - **Planner (調査)**: コード読み込み
   - **Planner (回答)**: 概要説明 + フロー図作成

4. **検証ポイント**
   - [ ] ファイルを変更せずに回答できたか？
   - [ ] 正確な情報に基づいているか？
   - [ ] ユーザーの意図を汲み取れたか？

---

## E-4: セッション管理パターン検証

### シナリオ概要
作業の中断と再開を行う。

### 期待されるフロー

1. **セッション中断**
   - User: "今日はここまで"
   - Orchestrator: **セッション管理パターン** (終了)
   - **BookKeeper**: `WORKFLOW.yaml` 更新
   - **DBManager**: 知見を `goku.md` に保存
   - **GrowthMonitor**: 振り返り実行

2. **セッション再開**
   - User: "続きから" (`/resume-session`)
   - Orchestrator: **セッション管理パターン** (再開)
   - **BookKeeper**: `WORKFLOW.yaml` 読み込み
   - 状態復元: Phase D-2 から再開

3. **検証ポイント**
   - [ ] 進捗が正しく保存されたか？
   - [ ] 再開時にコンテキストが復元されたか？
   - [ ] 忘れずに振り返りを行ったか？

---

## E-5: エラーケース検証

### シナリオ概要
実装中に重大なエラーが発生した場合の挙動。

### 期待されるフロー

1. **エラー発生**
   - **Coder**: ビルドエラー発生（依存関係の衝突）
   - Orchestrator: エラー検知

2. **エスカレーション**
   - `53-user-checkpoint.md` 参照
   - 条件: 重大エラー発生 → **ユーザー確認必須**

3. **ユーザー確認**
   - Orchestrator: "依存関係のエラーで進めません。どうしますか？"
     1. 強制インストール
     2. バージョンを下げる
     3. 中断

4. **復旧**
   - User: "2. バージョンを下げる"
   - Orchestrator: 指示通り実行
   - **Coder**: `package.json` 修正して再試行

5. **検証ポイント**
   - [ ] 勝手に進めずに止まったか？
   - [ ] 適切な選択肢を提示できたか？
   - [ ] ユーザー指示に従って復旧できたか？
