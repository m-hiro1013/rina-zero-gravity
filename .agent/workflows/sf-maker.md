---
description: 作業に必要なSkillとFlowを一問一答形式でヒアリングしながら、調査→実装→テスト→完成→フロー組み込みまでを一貫して行うRPA専用ワークフロー。
---
# 🎀 /sfmaker - Skill & Flow Maker ワークフロー

> **「Skillを作って、Flowに組み込む。それがRPA開発の全て。」**
> このワークフローは、RPAプロジェクトにおけるSkillとFlowの作成を
> 一問一答形式でヒアリングしながら、確実に完成まで導くためのもの。

---

## 📋 目次

1. [前提条件と事前チェック](#phase-0-前提条件と事前チェック)
2. [ヒアリング（目的の明確化）](#phase-1-ヒアリング目的の明確化)
3. [Skill調査（既存資産の棚卸し）](#phase-2-skill調査既存資産の棚卸し)
4. [Gap分析（不足Skillの特定）](#phase-3-gap分析不足skillの特定)
5. [実装プラン作成](#phase-4-実装プラン作成)
6. [Test実験（動作確認）](#phase-5-test実験動作確認)
7. [Skill作成（本番化）](#phase-6-skill作成本番化)
8. [Flow組み込み](#phase-7-flow組み込み)
9. [完了報告と進捗更新](#phase-8-完了報告と進捗更新)
10. [ルールと制約](#ルールと制約)

---

## Phase 0: 前提条件と事前チェック

### 🔐 必須条件（これが揃わないと開始不可）

| # | チェック項目 | 確認方法 |
|---|------------|---------|
| 1 | プロジェクトルートに `.env` が存在する | `ls -la .env` |
| 2 | `prompt/WORKFLOW.yaml` が存在する | ファイル確認 |
| 3 | `prompt/PROJECT_SPECIFIC.yaml` が存在する | ファイル確認 |
| 4 | `DEVELOPMENT_FLOW.md` を読んでいる | ファイル確認 |
| 5 | 対象媒体のフォルダ構成を把握している | `ls -la <媒体>/skill/` |

### 📖 事前読み込み（必ず実行）

```
1. prompt/WORKFLOW.yaml を読み込む（現在の進捗把握）
2. prompt/PROJECT_SPECIFIC.yaml を読み込む（技術スタック確認）
3. DEVELOPMENT_FLOW.md を読み込む（開発フロー確認）
4. 対象媒体の skill/ フォルダを ls する（既存Skill一覧）
5. 対象媒体の flow/ フォルダを ls する（既存Flow一覧）
```

### 🚫 禁止事項（Phase 0 で宣言）

以下を作業開始前に意識に刻む：

1. **testに本番コードを書かない**（動作確認のみ）
2. **同じ機能を複数の場所に実装しない**（漏れダブり禁止）
3. **workflow内で新しいブラウザ操作を書かない**（skillに分解）
4. **完了したtestを残さない**（削除必須）
5. **ドキュメントなしでskillを作らない**（冒頭コメント必須）
6. **ユーザーの承認なしで実装を開始しない**（プラン先出し）
7. **既存の関数名・変数名を勝手に変えない**

---

## Phase 1: ヒアリング（目的の明確化）

> **ルール: 1問1答形式。各質問で3案 + おすすめを提示。**

### Q1: 何を自動化したい？

```
よっしゃ！SFmaker起動するよ〜✨
まず教えて！何を自動化したい？

1️⃣ 既存Flowの拡張（今あるFlowに新しい操作を追加）
2️⃣ 新規Flowの作成（全く新しい業務フローを作る）
3️⃣ 既存Skillの改善（今あるSkillを修正・強化）

⭐ おすすめ: あなたの状況に合わせて判断するね！

具体的にやりたいことも一緒に教えてくれると嬉しい！
```

→ ユーザーの回答を待つ。**回答が来るまで次に進まない。**

### Q2: 対象の媒体は？

```
OK！次に、どの媒体で作業する？

1️⃣ hotpepper（ホットペッパーグルメ CMS）
2️⃣ 新しい媒体を追加する（フォルダごと新規作成）
3️⃣ 汎用（媒体に依存しない共通Skill）

⭐ おすすめ: 既存の媒体なら 1️⃣、新しいサイトなら 2️⃣ だね！
```

→ ユーザーの回答を待つ。

### Q3: 操作の詳細は？

```
どんな操作をするか、もう少し詳しく教えて！

1️⃣ b-logのデータを持っている（操作ログから再現する）
2️⃣ 手順書がある（テキストで手順を持っている）
3️⃣ 口頭で説明する（りなが質問しながら整理する）

⭐ おすすめ: b-logがあると最速で作れるから 1️⃣ が最強！
```

→ ユーザーの回答を待つ。

### Q4: 完成イメージは？

```
完成した時、どういう状態になってたらOK？

1️⃣ 単体のSkillとして使えればOK（Flowへの組み込みは後でやる）
2️⃣ 既存Flowに組み込んで、一連の業務として動く状態
3️⃣ 新規Flowとして、start→finish まで一括実行できる状態

⭐ おすすめ: まずは 1️⃣ でSkillを確実に作ってから、
  2️⃣ or 3️⃣ に進むのが安全だよ！
```

→ ユーザーの回答を待つ。

### ✅ Phase 1 完了条件

- [ ] 自動化したい内容が明確になった
- [ ] 対象媒体が決まった
- [ ] 操作の詳細（b-log / 手順書 / 口頭）が決まった
- [ ] 完成イメージが合意された

### 📝 Phase 1 成果物

```yaml
sfmaker_context:
  goal: "{{ユーザーの回答をまとめた目的}}"
  medium: "{{対象媒体}}"
  input_type: "b-log | 手順書 | 口頭"
  completion_image: "Skillのみ | 既存Flow組込 | 新規Flow"
```

---

## Phase 1.5: 仕様理解の事実確認（/fact-check） 🆕

**ヒアリングで聞き取った内容に対する理解を、一問一答形式で確認する！**

### 📝 手順

1. **ユーザーから提示された情報を分解**
   - データフォーマット（特殊な記法、区切り文字等）
   - 媒体固有の用語や仕様
   - 操作の前提条件や制約

2. **一問一答形式で確認**
   - `/fact-check` ワークフローに従い、1つずつ確認する
   - 各質問で3案 + おすすめを提示
   - **ユーザーが訂正した内容は即座に `BOOK.md` に永久保存**

3. **完了後、Phase 2 へ遷移**

### ✅ Phase 1.5 完了条件

- [ ] 全ての不明点・曖昧な点について一問一答で確認済み
- [ ] ユーザーから訂正があった場合、即座に `BOOK.md` に永久保存済み
- [ ] 仕様理解が100%確定した状態でPhase 2 に移行



## Phase 2: Skill調査（既存資産の棚卸し）

### 📝 手順

1. **対象媒体の skill/ フォルダを全スキャン**
   ```bash
   ls -la <媒体>/skill/
   ```

2. **各Skillファイルの冒頭コメントを読む**
   - 各ファイルの `"""..."""` ドキュメンテーション文字列を確認
   - 何ができるか、引数は何か、戻り値は何かを把握

3. **既存Skillの一覧表を作成してユーザーに提示**

```
📦 既存Skillの棚卸し完了！

| # | ファイル | 機能 | 使える？ |
|---|---------|------|---------|
| 1 | auth.py | ログイン処理 | ✅ そのまま使える |
| 2 | navigation.py | 画面遷移 | ✅ そのまま使える |
| 3 | drink_ops.py | ドリンク操作 | ⚠️ 一部使える |
| 4 | category_ops.py | カテゴリー操作 | ⚠️ 一部使える |
| ... | ... | ... | ... |

全部確認したよ！次のPhaseで不足分を分析するね✨
```

### ✅ Phase 2 完了条件

- [ ] 対象媒体の全Skillファイルを読んだ
- [ ] 各Skillの機能・引数・戻り値を把握した
- [ ] 使えるもの / 使えないもの / 一部使えるもの を分類した
- [ ] 一覧表をユーザーに提示した

---

## Phase 3: Gap分析（不足Skillの特定）

### 📝 手順

1. **目的（Phase 1）と既存資産（Phase 2）を突き合わせる**
2. **不足しているSkillを具体的にリストアップ**
3. **ユーザーに確認**

```
🔍 Gap分析の結果だよ！

## ✅ 既存Skillでカバーできる部分
- ログイン → auth.login()
- ドリンクメニューへ遷移 → navigation.navigate_to_drink()

## ⚠️ 新しく作る必要があるSkill
| # | Skill名 | 機能 | 優先度 |
|---|---------|------|-------|
| 1 | {{skill_name_1}} | {{description}} | 🔴 必須 |
| 2 | {{skill_name_2}} | {{description}} | 🟡 あると便利 |
| 3 | {{skill_name_3}} | {{description}} | 🟢 将来的に |

## 🤔 確認したいこと
{{不明点があれば質問}}

この分析で合ってる？修正あったら教えて！
```

→ ユーザーの回答を待つ。

### Q5: どのSkillから作る？

```
どの順番で作っていく？

1️⃣ 優先度順（🔴 必須 → 🟡 → 🟢）
2️⃣ 依存関係順（他のSkillが必要とするものから）
3️⃣ カスタム順（自分で決める）

⭐ おすすめ: 2️⃣ 依存関係順が一番安全！
  基盤になるSkillから作れば、後のSkillが楽になるよ✨
```

→ ユーザーの回答を待つ。

### ✅ Phase 3 完了条件

- [ ] 不足Skillが全てリストアップされた
- [ ] 作成順序が決まった
- [ ] ユーザーの承認を得た

---

## Phase 4: 実装プラン作成

### 📝 手順

Phase 1〜3の情報を統合し、具体的な実装プランを作成する。

```
📋 実装プラン完成！

━━━━━━━━━━━━━━━━━━━━
## 🎯 目標
{{goal}}

## 📊 作業サマリー
- 新規Skill: {{N}}個
- 修正Skill: {{M}}個
- Flow: {{X}}（新規 or 既存修正）
- 推定サイクル数: {{Y}}

━━━━━━━━━━━━━━━━━━━━
## 📝 詳細プラン

### Cycle 1: {{skill_name_1}}
- **ファイル**: `<媒体>/skill/{{filename}}.py`
- **機能**: {{description}}
- **関数**: `{{function_name}}(page, arg1, arg2)`
- **依存**: {{dependency or "なし"}}
- **テスト**: `tests/test_experiment_{{name}}.py`

### Cycle 2: {{skill_name_2}}
...

### Cycle N: Flow組み込み
- **ファイル**: `<媒体>/flow/{{flow_name}}.py`
- **使用Skill**: {{list}}

━━━━━━━━━━━━━━━━━━━━

このプランで進めていい？
修正があったら何でも言ってね！
```

→ **ユーザーのGOサインを待つ。これが最大のチェックポイント！**

### ✅ Phase 4 完了条件

- [ ] 実装プランが作成された
- [ ] 全Cycle（全Skill + Flow）の詳細が記載されている
- [ ] ユーザーが実装プランを承認した（**GOサイン必須**）

---

## Phase 5: Test実験（動作確認）

> **DEVELOPMENT_FLOW.md の Phase 2 に準拠**
> テストは動作確認のみ。本番コードは書かない。

### 📝 手順（各Skillごとに繰り返す）

1. **testフォルダに実験用ファイルを作成**
   ```
   tests/test_experiment_{{skill_name}}.py
   ```

2. **既存Skillを併用して最小限のコードで動作確認**
   ```python
   # ✅ 正しい例: 既存skillを使って動作確認
   from hotpepper.skill.auth import login
   from hotpepper.skill.navigation import navigate_to_drink

   async def test_experiment():
       await login(page, LOGIN_ID, PASSWORD, BASE_URL)
       await navigate_to_drink(page)
       # ここだけ新しい操作を試す
       await page.click("#newButton")
   ```

3. **絶対にやらないこと**
   - ❌ 新しいヘルパー関数を作る
   - ❌ 新しいクラスを作る
   - ❌ 正式なloopや条件分岐を書く
   - ❌ エラーハンドリングを本格的に書く

4. **動作確認結果をユーザーに報告**

```
🧪 Test実験結果: {{skill_name}}

## 結果: ✅ 成功 / ❌ 失敗

## 試したこと
1. {{step_1}} → {{result}}
2. {{step_2}} → {{result}}

## 発見した注意点
- {{caution_1}}
- {{caution_2}}

## 次のステップ
→ Phase 6 でSkillに分解するね！
```

### ⚠️ 失敗時のルール

| 回数 | 対応 |
|------|------|
| 1回目失敗 | 原因を特定し、修正してリトライ |
| 2回目失敗 | アプローチを見直し、プランから再検討 |
| 3回目失敗 | ユーザーに相談（エスカレーション） |

### ✅ Phase 5 完了条件

- [ ] 全ての新規Skillの動作確認が完了した
- [ ] 各Skillのセレクタ・操作手順が確定した
- [ ] 注意点（iframe、モーダル、待機時間等）が特定された
- [ ] テスト結果をユーザーに報告した

---

## Phase 6: Skill作成（本番化）

> **DEVELOPMENT_FLOW.md の Phase 3 に準拠**

### 📝 手順（各Skillごとに繰り返す）

1. **testで確認した操作をSkill関数に分解**

2. **Skillファイルに実装**
   - ファイル: `<媒体>/skill/{{filename}}.py`
   - 冒頭にDEVELOPMENT_FLOW.md準拠のドキュメンテーション文字列を記載

3. **冒頭コメント（必須テンプレート）**
   ```python
   """
   {{Skillの名前}} - {{簡潔な説明}}

   ## 🎯 目的
   {{このSkillが何をするか、なぜ必要か}}

   ## 📋 機能一覧
   - {{機能1}}: {{説明}}

   ## 🔧 事前準備
   ### 必要な環境変数（.env）
   - `{{ENV_VAR}}`: {{説明}}

   ## 💡 使い方
   ```python
   from <媒体>.skill.{{module}} import {{function}}
   await {{function}}(page, arg1, arg2)
   ```

   ## ⚠️ 注意事項
   - {{注意点}}

   ## 🔗 関連Skill
   - `{{related}}.py`: {{説明}}
   """
   ```

4. **漏れダブりチェック**
   - 既存Skillと重複していないか全ファイル確認
   - 同じ操作が別のSkillに既にないか確認

5. **testから実験用ファイルを削除**
   ```bash
   rm tests/test_experiment_{{skill_name}}.py
   ```

6. **ユーザーに報告**

```
🛠️ Skill作成完了: {{skill_name}}

## 作成ファイル
`<媒体>/skill/{{filename}}.py`

## 追加した関数
- `{{function_name}}(page, arg1, arg2)`: {{説明}}

## 削除したテスト
- `tests/test_experiment_{{skill_name}}.py`

## セルフチェック
- [ ] 冒頭コメント記載済み
- [ ] 既存Skillと重複なし
- [ ] テストファイル削除済み
- [ ] 関数名・引数が明確

次のSkillに進む？
```

### ✅ Phase 6 完了条件（各Skill）

- [ ] Skillファイルが作成された
- [ ] 冒頭にドキュメンテーション文字列が記載されている
- [ ] 既存Skillと重複していない
- [ ] テストファイルが削除された
- [ ] ユーザーに報告済み

---

## Phase 7: Flow組み込み

> **DEVELOPMENT_FLOW.md の Phase 4 に準拠**
> Phase 4 の実装プランで「Flow組み込み」が含まれている場合のみ実行。

### 📝 手順

1. **全Skillが揃っているか最終確認**

```
📦 Flow組み込み前の最終チェック！

## 必要なSkill → 全て揃ってる？
| # | Skill | ファイル | 状態 |
|---|-------|---------|------|
| 1 | ログイン | auth.py | ✅ 既存 |
| 2 | ナビゲーション | navigation.py | ✅ 既存 |
| 3 | {{new_skill}} | {{file}}.py | ✅ 新規作成済み |

全部揃ってるね！Flow組み込み開始するよ✨
```

2. **Flowファイルの作成 or 修正**

   ```python
   """
   {{Flowの名前}} - {{簡潔な説明}}

   ## 🎯 目的
   {{このFlowが何をするか}}

   ## 📋 処理フロー
   1. {{step_1}}
   2. {{step_2}}

   ## 🧩 使用しているSkill
   - `auth.login()`: ログイン処理
   - `navigation.navigate_to_drink()`: ドリンクメニューへ遷移
   - `{{new_skill}}()`: {{説明}}
   """
   ```

3. **Flow内でブラウザ操作を直接書いていないかセルフチェック**
   - ❌ `await page.click(...)` がFlowファイル内にある → Skillに分解
   - ✅ `await some_skill(page, ...)` のみ → OK

4. **動作確認**
   - Flowを実行して、start→finish まで動くか確認
   - 問題があれば該当Skillを修正（Flow自体は触らない）

### ✅ Phase 7 完了条件

- [ ] 全てのSkillがFlowに組み込まれた
- [ ] Flow内にブラウザ直接操作がない
- [ ] 冒頭にドキュメンテーション文字列が記載されている
- [ ] start→finish の動作確認が完了した

---

## Phase 8: 完了報告と進捗更新

### 📝 手順

1. **WORKFLOW.yaml を更新**
   ```yaml
   # タスクのステータスを done に変更
   # 新しいファイルを file_structure.created に追加
   # 削除したファイルを file_structure.deleted に追加
   # last_session_summary を更新
   ```

2. **FILES.md を更新**
   - 新しく作成したSkill/Flowファイルを追記

3. **KNOWLEDGE.md に知見を追記**（該当する場合のみ）

4. **完了報告**

```
🎉 SFmaker完了！

━━━━━━━━━━━━━━━━━━━━
## ✅ 完了した内容
{{goal}}

## 📝 作成したファイル
| # | ファイル | 種別 | 説明 |
|---|---------|------|------|
| 1 | {{file_1}} | Skill | {{desc}} |
| 2 | {{file_2}} | Flow | {{desc}} |

## 🗑️ 削除したファイル
- `tests/test_experiment_xxx.py`

## 📊 進捗更新
- WORKFLOW.yaml: ✅ 更新済み
- FILES.md: ✅ 更新済み

## ⚠️ 注意点
- {{caution}}

## 🎯 次にやれること
1. {{next_1}}
2. {{next_2}}
━━━━━━━━━━━━━━━━━━━━

お疲れ様〜！最高のSkill & Flow完成したね！✨💖
```

### ✅ Phase 8 完了条件

- [ ] WORKFLOW.yaml が更新された
- [ ] FILES.md が更新された
- [ ] 完了報告をユーザーに行った

---

## ルールと制約

### 🔴 絶対遵守事項（違反は即停止）

| # | ルール | 理由 |
|---|--------|------|
| 1 | **ユーザー承認なしで実装開始しない** | Phase 4 のGOサインが最大のチェックポイント |
| 2 | **1問1答形式を守る** | 複数質問を一度に出さない |
| 3 | **各質問で3案 + おすすめを提示** | ユーザーの判断を助ける |
| 4 | **testに本番コードを書かない** | DEVELOPMENT_FLOW.md 準拠 |
| 5 | **workflow内でブラウザ操作を直接書かない** | skillに分解する |
| 6 | **完了したtestを残さない** | 削除必須 |
| 7 | **ドキュメントなしでskillを作らない** | 冒頭コメント必須 |
| 8 | **既存の関数名・変数名を変えない** | RINA System Protocol 準拠 |
| 9 | **同じ機能を複数箇所に実装しない** | 漏れダブり禁止 |
| 10 | **2回失敗したらプラン見直し** | 無限ループ禁止 |

### 🟡 注意事項

| # | 注意 | 対処 |
|---|------|------|
| 1 | iframe内の要素操作 | `page.frame(name='xxx')` で切り替え |
| 2 | モーダル消去後のオーバーレイ | `click(force=True)` で対応 |
| 3 | ボタン文言の揺れ | `*` 検索や複数パターンで対応 |
| 4 | 画面遷移後の復帰 | 元の画面に戻るまでを1つのSkillにする |
| 5 | b-logの isInIframe 情報 | iframe切り替えの判断に活用 |

### 🟢 推奨事項

| # | 推奨 | 理由 |
|---|------|------|
| 1 | b-logを活用する | 最速でセレクタを特定できる |
| 2 | headless=False で開発 | 目視確認で安定性が上がる |
| 3 | slow_mo を設定する | 操作の安定性が向上する |
| 4 | caffeinate を使う | Mac スリープ防止 |
| 5 | スクリーンショットを撮る | デバッグ時の証拠になる |

---

## フェーズ間の遷移ルール

```
Phase 0 → Phase 1: 事前チェック完了後、自動遷移
Phase 1 → Phase 1.5: ヒアリング完了後、自動遷移 🆕
Phase 1.5 → Phase 2: 仕様理解確認完了後、自動遷移 🆕
Phase 2 → Phase 3: Skill調査完了後、自動遷移
Phase 3 → Phase 4: Gap分析完了+ユーザー承認後、遷移
Phase 4 → Phase 5: 実装プラン承認（GOサイン）後、遷移 ← 最重要チェックポイント
Phase 5 → Phase 6: 各Skillの動作確認完了後、遷移（Skillごとに5→6を繰り返す）
Phase 6 → Phase 5: 次のSkillがあれば Phase 5 に戻る
Phase 6 → Phase 7: 全Skill完了 + Flow組み込みが必要な場合
Phase 6 → Phase 8: 全Skill完了 + Flow不要の場合
Phase 7 → Phase 8: Flow組み込み完了後、遷移
```

### エラー遷移

```
任意のPhase → Phase 4: 2回失敗でプラン見直し
任意のPhase → ユーザー相談: プラン見直しでも解決しない場合
```

---

## クイックリファレンス

### ヒアリング質問テンプレート

```
{{質問文}}

1️⃣ {{選択肢1}}
2️⃣ {{選択肢2}}
3️⃣ {{選択肢3}}

⭐ おすすめ: {{推奨理由を含めた説明}}
```

### Skill作成テンプレート

```python
"""
{{Skill名}} - {{説明}}

## 🎯 目的
## 📋 機能一覧
## 🔧 事前準備
## 💡 使い方
## ⚠️ 注意事項
## 🔗 関連Skill
## 📊 動作イメージ
## 🧪 テスト方法
"""

from playwright.async_api import Page

async def {{function_name}}(page: Page, {{args}}) -> {{return_type}}:
    """{{簡潔な説明}}"""
    # 実装
    pass
```

### 進捗報告テンプレート

```
📊 進捗: Cycle {{N}}/{{Total}}

✅ 完了: {{completed_skills}}
🔧 作業中: {{current_skill}}
⏳ 残り: {{remaining_skills}}

問題なく進んでるよ〜！✨
```
