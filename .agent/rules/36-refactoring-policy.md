---
trigger: model_decision
description: 機能等価性維持、リファクタリングの鉄則に関するルールだよ！「前と同じに動く」ことへのガチなこだわり💅
slug: refactoring-policy
inheritance: core
scope: global
---
# リファクタリング・移行ポリシー (Refactoring & Migration Policy)

既存コードを新しい技術スタック（Vue.js, Reactなど）に移行、またはリファクタリングする際に **絶対に守るべき基準** です。
「コードをきれいにすること」よりも「既存の機能を完全に維持すること」を最優先とします。

## ⚠️ 鉄の掟：機能等価性（Feature Parity）の死守

### 1. 「省略」の厳禁
既存コードに存在するロジック、分岐、表示項目は、**ユーザーから明示的な削除指示がない限り、100%再現しなければならない。**
「使われてなさそうだから」「複雑だから」という理由で、自己判断で簡略化してはならない。

- **❌ NG**: 「複雑な表だったので、主要な列だけ表示しました」
- **✅ OK**: 「既存の表の全カラム（計算ロジック含む）をVueコンポーネントに移植しました」

### 2. ロジックの完全移植
特に数値計算、データ加工のロジックは、行単位で追跡し、新環境でも全く同じ結果が出ることを保証すること。
変数名が変わっても、計算式は等価でなければならない。

### 3. UI/UXの維持
デザインをモダンにする場合でも、以下の要素は維持すること：
- 情報量（表示される項目数）
- 操作の動線
- リンクやボタンの機能（外部連携など）

## 🔍 作業プロセス

リファクタリングを行う際は、以下の手順を踏むこと：

1.  **現状分析 (As-Is)**:
    - 既存ファイルの機能をリストアップする。
    - 特に `format` 関数や 計算ロジック、条件分岐を洗い出す。

2.  **マッピング**:
    - 旧コードのどの関数が、新コードのどこに対応するかを明確にする。

3.  **実装 (To-Be)**:
    - リファクタリング中、「この機能は移行したか？」を常に自問する。
    - **迷ったら「全部」移行する。**

4.  **検証**:
    - 旧画面と新画面を見比べ、欠けている情報がないか確認する。

## 🚨 注意すべき「兆候」

以下のセリフを言いそうになったら、このルールを思い出して停止すること：
- 「一旦、基本的な機能だけ実装しました」
- 「デザインに合わせて項目を整理しました」
- 「詳細なロジックは後回しにしました」

**→ これらはすべて「機能劣化（Regression）」である。**
ユーザーは「モダンで使いやすい、**同じ機能のツール**」を求めていることを忘れないこと。

## 🔗 View-Data インターフェース整合性

テンプレート（HTML/Vue/React）とデータモデル（JS）の間でキー名・構造が一致しているか必ず確認すること。

- テンプレートが `media.key` を参照しているなら、データは `key` で返す（`media_key` ではない）
- 構造の不一致は実行時エラーや空欄表示を招く
- **コード書いた → データ構造の整合性確認 → 画面確認 → 完了** のフローを徹底
