---
description: 自動継続とユーザー確認の境界を定義する。いつ確認を求め、いつ自動で進めるか。
---

# ユーザー確認条件定義 (User Checkpoint)

> 自動で進めるか、確認を求めるか。その判断基準。

## 概要

エージェントが自律的に動作しながらも、必要な場面では必ずユーザーに確認を求める。
このルールは「自動継続」と「ユーザー確認」の境界を明確にする。

---

## 自動継続の条件（確認不要）

以下のすべてを満たす場合、ユーザー確認なしで次のフェーズ/サイクルに進む。

### 1. 正常完了

```yaml
auto_continue:
  - phase_completed: true          # フェーズが正常完了
  - no_errors: true                # 重大エラーなし
  - within_estimate: true          # 見積もりサイクル内
  - no_design_change: true         # 設計方針変更なし
  - no_security_decision: true     # セキュリティ判断不要
```

### 2. 具体的な条件

| 条件 | 説明 |
|------|------|
| **フェーズ正常完了** | フェーズの終了条件を満たした |
| **エラーなし** | ビルド成功、テスト合格、重大エラーなし |
| **見積もり内** | 現在サイクル < 見積もりサイクル |
| **設計変更なし** | 元の方針で進められる |
| **セキュリティ判断不要** | APIキー、本番DB、権限等の判断不要 |

---

## ユーザー確認の条件（確認必須）

以下のいずれかに該当する場合、必ずユーザーに確認を求める。

### 1. 見積もりサイクル完了

```yaml
checkpoint:
  trigger: "見積もりサイクル完了"
  when: current_cycle >= estimated_cycles
  action: "現状報告 + 継続判断を仰ぐ"
```

**確認時の報告内容**:
```markdown
📊 進捗レポート

## 完了サイクル
- サイクル1: {{成果サマリー}}
- サイクル2: {{成果サマリー}}
...

## 現在の状態
- 実装済み機能: {{リスト}}
- 残タスク: {{リスト}}

## 次のアクション
1️⃣ このまま続ける（追加サイクル）
2️⃣ 一旦完了とする
3️⃣ 方針を変更する

どうする？
```

---

### 2. 重大エラー発生

```yaml
checkpoint:
  trigger: "重大エラー"
  when:
    - build_failed: true           # ビルド不能
    - all_tests_failed: true       # テスト全滅
    - critical_error: true         # クリティカルエラー
    - dependency_issue: true       # 依存関係問題
  action: "エラー報告 + 対処方針を仰ぐ"
```

**確認時の報告内容**:
```markdown
⚠️ 重大エラー発生

## エラー内容
{{エラーの説明}}

## 原因の推測
1. {{推測1}}
2. {{推測2}}

## 対処案
1️⃣ {{対処案1}}
2️⃣ {{対処案2}}
3️⃣ 作業を中断して相談

どう進める？
```

---

### 3. 設計方針の変更が必要

```yaml
checkpoint:
  trigger: "設計変更必要"
  when:
    - scope_expansion: true        # スコープ拡大
    - tech_stack_change: true      # 技術スタック変更
    - architecture_change: true    # アーキテクチャ変更
  action: "変更提案 + 承認を仰ぐ"
```

**確認時の報告内容**:
```markdown
🔄 設計変更の提案

## 現状
{{現在の設計}}

## 変更が必要な理由
{{理由}}

## 変更案
{{新しい設計}}

## 影響
- 追加作業: {{見積もり}}
- リスク: {{リスク}}

この変更で進めていい？
```

---

### 4. セキュリティに関わる判断

```yaml
checkpoint:
  trigger: "セキュリティ判断"
  when:
    - api_key_handling: true       # APIキーの扱い
    - production_db_access: true   # 本番DB操作
    - permission_change: true      # 権限変更
    - sensitive_data: true         # 機密データ操作
  action: "リスク説明 + 承認を仰ぐ"
```

**確認時の報告内容**:
```markdown
🔐 セキュリティ確認

## 操作内容
{{操作の説明}}

## リスク
{{リスクの説明}}

## 安全対策
- {{対策1}}
- {{対策2}}

この操作を実行していい？
```

---

### 5. 複数の選択肢がある場合

```yaml
checkpoint:
  trigger: "選択肢あり"
  when:
    - multiple_approaches: true    # 複数のアプローチ可能
    - trade_off: true              # トレードオフがある
  action: "選択肢提示 + 選択を仰ぐ"
```

**確認時の報告内容**:
```markdown
🤔 選択が必要

## 状況
{{状況説明}}

## 選択肢
1️⃣ {{選択肢1}}
   - メリット: {{メリット}}
   - デメリット: {{デメリット}}

2️⃣ {{選択肢2}}
   - メリット: {{メリット}}
   - デメリット: {{デメリット}}

どっちにする？
```

---

## ユーザー回答パターンと次のアクション

| 入力パターン | 解釈 | 次のアクション |
|-------------|------|---------------|
| `1`, `1️⃣`, `選択肢1` | 選択肢1を選択 | 選択肢1で進行 |
| `2`, `2️⃣`, `選択肢2` | 選択肢2を選択 | 選択肢2で進行 |
| `続ける`, `続行`, `次いこ` | 現状のまま続行 | 自動継続再開 |
| `止めて`, `中断`, `ストップ` | 作業中断 | セッション保存して終了 |
| `変更して`, `やり直し` | 方針変更 | 変更内容を確認 |
| 具体的な指示 | 指示に従う | 指示通りに進行 |

---

## 確認頻度の調整

### デフォルト設定
- 見積もりサイクルごとに確認
- 重大イベント発生時に確認

### 頻度上げ（慎重モード）
```
ユーザーが「こまめに確認して」と言った場合：
- 各サイクル完了時に確認
- 各フェーズ完了時にサマリー報告
```

### 頻度下げ（お任せモード）
```
ユーザーが「任せる」「自由にやって」と言った場合：
- 自動継続の範囲を拡大
- ただし、セキュリティ確認は省略しない
```

---

## Orchestratorへの指示

フェーズ/サイクル完了時：

1. 自動継続条件をチェック
2. すべて満たす → 自動で次へ
3. いずれか該当 → ユーザー確認を実行
4. 確認結果に従って進行

### 確認時の原則

- **簡潔に**: 長文は避ける
- **選択肢を明示**: 数字で選べるように
- **理由を説明**: なぜ確認が必要か
- **推奨を示す**: 可能なら推奨案を提示

---

## 絶対に確認をスキップしてはいけない場面

1. **本番環境への操作**
2. **データ削除を伴う操作**
3. **外部サービスへの課金発生**
4. **ユーザーの個人情報に触れる操作**
5. **不可逆な操作**

これらは**頻度下げモードでも確認必須**。
