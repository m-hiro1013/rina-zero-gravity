アーキテクチャ:
  スタイル: "モダンなシングルページアプリケーション (SPA)"
  フロントエンド: "React (TypeScript)"
  スタイリング: "Tailwind CSS"

解析エンジン:
  名称: "Universal ToonParser"
  設計: "文脈を考慮した欲張り（greedy）パーサー"
  機能:
    - "動的テーブル解決: 解析中にヘッダーと行数を動的に読み取り、型定義なしで新規データの取り込みが可能"
    - "階層構造による保存: 店舗 (shops) およびメディア詳細 (media_data) を階層的にオブジェクト化"
    - "データパス解決: React 側でのパス指定（shop.media_data.媒体名）による直感的なデータアクセスの実現"

データフロー:
  - "public/toon.txt -> fetch(URL) -> parseToon() -> React State -> 選択された店舗コンポーネント"

ステータス:
  完了した機能:
    - "Universal Toon 解析エンジン"
    - "店舗ナビゲーションと選択"
    - "「売り上げ」タブ：税込計算およびウォークインの除外"
    - "店舗詳細：直近のプラン変更検出（過去6ヶ月分）"
    - "toretaタブ：全機能（構成比テーブル・棒グラフ・指標トグル）"
    - "食べログタブ：全機能（構成比テーブル・棒グラフ・利益ロジック）"
  未完了の機能:
    - "個別媒体セクション（ホットペッパー等）の詳細コンテンツ"
    - "1ファイル構成によるHTMLエクスポート機能"

ビジネスロジック:
  売上計算:
    - "売上金額は税込で表示（税抜金額に 1.1 を掛ける）"
    - "計算式: Math.round(税抜売上 * 1.1)"
    - "定数 TAX_RATE (1.1) を使用"

  予約指標 (予約組数・人数):
    - "純粋なネット予約データとして算出するため、来店経路から「ウォークイン」を除外する"
    - "計算式: トレタ合計データ - ウォークインデータ"
    - "対象: 予約組数 (reservation_count) および 予約人数 (guest_count)"

  前年同月比 (YoY):
    - "計算対象: 税込売上、ネット予約組数、ネット予約人数"
    - "算出式: (当月値 / 前年同月値) * 100"
    - "表示形式: 小数点第1位まで表示（例: 105.2%）"
    - "カラーリング: 100%以上は緑 (#10b981)、100%未満は赤 (#ef4444) で強調表示"
    - "合計行には YoY を表示せず '-' とする"

    - [x] 対象: shop.media_data 内の各媒体の `plan_name` の変化
    - [x] 除外ノイズ: `ad_cost_data` はプラン名ではない広告費項目のため、検出対象から除外する
    - [x] 期間: ユーザーが選択した「終了月」から遡って 6ヶ月間を対象とする
    - [x] 表示: 旧プラン名と新プラン名を時系列でリスト表示
    - [x] 費用表示: プラン名に加え、月額費用（`base_cost`）を併記する
    - [x] フィルタリング: `plan_name` が `null` の行は無視される（プランの契約開始/終了そのものは検出せず、名称の変更のみを追う仕様）

  レポート期間の自動設定:
    - "初期表示: データの最新月（endMonth）と、その11ヶ月前（最新含めて1年前）をデフォルト期間とする"
    - "下限ガード: 計算された開始月がデータの開始月（startMonth）より前の場合は、データの開始月を優先する"

  媒体名称の表示マッピング:
    - "システム内のキー名を表示用の日本語名に変換する"
    - "対応: tabelog -> 食べログ, hotpepper -> ホットペッパー, gurunavi -> ぐるなび, line -> LINE, conetto -> コネット"

  媒体別分析（食べログ）:
    データソース:
      - "媒体データ: shop.media_data.tabelog[] — PV、プラン名、ネット予約数、従量課金情報"
      - "トレタデータ: shop.toreta_data[] の media === '食べログ' 行 — トレタ経由の総予約数（ネット+ノート）"

    PV計算:
      - "店舗トップPV = pv_sp_top + pv_pc_top（SP版とPC版の合算）"
      - "合計PV = pv_sp_total + pv_pc_total（SP版とPC版の合算）"

    予約の分解:
      - "予約件数（親行） = toreta_data[食べログ].reservation_count（ノート含む総数）"
      - "内）web予約数 = tabelog.reservation_count_total（媒体のネット予約数）"
      - "内）ノート組数 = max(0, 予約件数 - web予約数)"
      - "予約人数（親行） = toreta_data[食べログ].guest_count（ノート含む総数）"
      - "内）web予約人数 = tabelog.guest_count_total（媒体のネット予約人数）"
      - "内）ノート人数 = max(0, 予約人数 - web予約人数)"

    CVR計算:
      - "CVR = web予約件数(tabelog.reservation_count_total) / 店舗トップPV × 100"
      - "分子にトレタの予約件数を使わない理由: PVはweb閲覧数であり、対応する転換もweb予約でなければ指標として不正確になるため"
      - "表示形式: 小数点第2位まで（例: 3.72%）"
      - "店舗トップPVが0の月は '-' 表示"

    費用計算:
      - "従量課金額 = トレタ予約人数 × ((unit_cost_lunch + unit_cost_dinner) / 2)"
      - "※ トレタにランチ/ディナー内訳がない期間の暫定ロジック"
      - "費用合計 = base_cost + 従量課金額"

    客単価:
      - "平均客単価 = (avg_price_lunch + avg_price_dinner) / 2"
      - "理由: 食べログ経由の予約はランチ・ディナー両方を含むため、両方の平均を採用"

    想定売上:
      - "想定売上（web予約） = web予約人数(tabelog.guest_count_total) × 平均客単価"
      - "想定売上（ノート） = ノート人数 × 平均客単価"
      - "想定売上（合計） = web予約分 + ノート分"
      - "web予約とノートを分離する理由: 媒体費用の効果測定にはweb予約の貢献を明確にする必要があるため"

    利益額:
      - "利益額 = (想定売上（合計）× 0.7) - 費用合計"
      - "※ 0.3は原価とみなして控除する"
      - "カラーリング: 0以上は緑、負は赤"

    送客コスト:
      - "送客コスト/人 = Math.floor(費用合計 / web予約人数)"
      - "分母にweb予約人数を使う理由: 費用はweb予約の仕組みに対して支払っているため"
      - "web予約人数が0の月は '-' 表示"

    将来の拡張性 (ひろきくんメモ 2026-02-17):
      - "トレタのデータ (toreta_data) にランチ/ディナーのフラグまたは人数パラメータを追加する予定"
      - "実装された際は、従量課金の計算を平均単価ではなく、実数 × 各単価に切り替える"

    合計列:
      - "月別の合計/平均列は設けない"
      - "理由: 期間合計のPVやCVR平均は実務上の意味が薄く、月次推移の把握が本テーブルの目的であるため"
