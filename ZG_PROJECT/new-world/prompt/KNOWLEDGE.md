# 🧠 KNOWLEDGE.md - 知見蓄積メモ

## 🛠 技術スタック・ハマりどころ

### Tailwind CSS v4 + Vite
- **問題**: `tailwindcss` を PostCSS プラグインとして直接使うと、Vite v7 + Node v24 環境で `uv_cwd` エラーや PostCSS 警告が出ることがある。
- **解決**: `@tailwindcss/vite` をインストールし、`vite.config.ts` の `plugins` に `tailwindcss()` を追加する。
- **重要**: この場合、`postcss.config.js` の `plugins` 内にある `tailwindcss` 指定は空にする（競合を防ぐため）。

### React / TypeScript Data Handling
- **問題**: `202601` のような ID や日付データを `toon.txt` (YAML形式) から読み込む際、パーサーが数値（Number）として解釈し、UI側で `.substring()` 等の文字列メソッドが呼べずにクラッシュする。
- **解決**: UI 側のユーティリティ関数（`formatYM` 等）で `String(val)` による明示的なキャストと、空値ガードを徹底する。

## 🎨 デザイン・UI 設計

### Skeleton First 原則
- 最初から凝ったデザインを作らず、まずはサイドバーのナビゲーション、データ取得、期間選択などの「骨組み」を完成させる。
- メインコンテンツはプレースホルダーで「今何を表示しようとしているか」を可視化する。

### 期間選択のデフォルト値
- **期間選択のデフォルト値**: レポートのデフォルト表示期間は「最新月」から「1年前」を自動計算してセットする。`toon.txt` の `export_info.period.end` を基準点にする。
- **Sticky Column Background**: テーブルの固定列（sticky）の背景色は絶対に透明（transparent）にしない。文字が重なって読みづらくなるため、必ず `white` や `gray-50` などの不透明色を指定すること。 [+5]

## 📍 プロジェクト特有のルール (new-world)
- **Source of Truth**: `sample/` フォルダ内の `sample.html`, `sample.css`, `sample.txt` が最終成果物の絶対的な指標。
- **実装順序**: 個別店舗 (Phase 2) -> 全店舗サマリー (Phase 3) の順で実装する。サマリーは個別データの集計になるため。

## 🧠 セッション知見 (2026-02-14)

### ビジネスロジックの管理
- **愛の約束**: 計算式やフィルタリング条件などの「ビジネスロジック」は、すべて `prompt/ARCHITECTURE.yaml` の `business_logic` セクションに日本語で記録する。 [+5]
- **理由**: 実装コード（App.tsx 等）は複雑になりやすいため、人間が読める仕様書をプロジェクトフォルダ内に一元管理することで、長期的なメンテナンス性を確保する。

### リッチなデータ可視化 (Interactive Graph)
- **外部詳細パネルパターン**: Recharts の Tooltip を使わず、`onMouseMove` で取得した状態を React State (`setHoveredData`) に保存し、グラフ外のコンポーネントで詳細を表示するパターン。狭い領域での視覚的ストレスを劇的に軽減できる。 [+4]
- **視認性特化のデコレーション**: テーブルの境界線を `gray-300` 等で強調し、さらに `scrollbar-gutter: stable` と特大パディング (`pr-12`) を組み合わせることで、OSごとのスクロールバー挙動に左右されない堅牢なUIを実現できる。 [+4]
- **動的指標切り替え (Metric Switching)**: 一つのコンポーネント状態で `count`（組数）と `guestCount`（人数）を切り替えるトグルを実装する際、テーブルのセル内数値だけでなく、グラフの `Stack` 構成や詳細パネルのラベルまで一貫して連動させることで、多角的な分析をストレスなく提供できる。 [+5]

### データ構造への適応
- **プラン変更検出**: `ad_cost_data` は他の媒体と同様に `media_data` 下に存在するが、中身が広告費（LINE用など）であるため、プラン変更検出からは除外する必要がある。 [+3]
- **トレタ計算**: ネット予約数を出すには「合計」から「ウォークイン」を引く必要がある。単なる `reservation_count` ではなく、媒体 `media` フラグを見た減算処理が必須。 [+3]

### 食べログ固有のネット/ノート分離ロジック
- **重要**: 食べログだけは「ネット予約」と「ノート予約」の分離が必要。他の媒体（ホットペッパー、ぐるなび等）ではトレタの値をそのままネット予約として扱う。
- **計算**: ノート = トレタ予約数 - tabelog.reservation_count_total（最小0）
- **理由**: 食べログは電話予約（ノート）もトレタに食べログ経由として記録されるが、媒体データにはネット予約のみが含まれるため。

### web予約基準の統一ルール
- **CVR**: 分子 = web予約件数（tabelog の値）。PVと同じwebチャネル同士で割るのが正しい。
- **送客コスト/人**: 分母 = web予約人数。費用はweb予約の仕組みへの支払いだから。
- **想定売上**: web予約とノートを分離して出す。利益額は合計から算出。

### 客単価の変更
- **旧**: avg_price_dinner のみ
- **新**: (avg_price_lunch + avg_price_dinner) / 2
- **注意**: この変更により sample.html の想定売上・利益額とは数値が異なるが、意図的な改善。

### Sticky Column 透過問題
- **問題**: 固定列（sticky）の背景色が透明だと、スクロール時に背面の文字が透けて重なり、可読性が著しく低下する。
- **解決**: `backgroundColor` には必ず不透明色（`#ffffff` や `#fed7aa` 等）を指定する。特にハイライト時はその色を明示的に指定する必要がある。 [+5]

### メディア利益額計算の標準化
- **ロジック**: 媒体の利益額を算出する際は「(想定売上 * 0.7) - 媒体費用」とする。
- **理由**: 飲食店の一般的な原価率（30%）を売上から控除することで、より実態に近い利益貢献度を可視化するため。 [+4]

### 状態の永続化 (Persistence)
- **パターン**: タブ切り替えなどでコンポーネントがアンマウントされる場合、その内部状態（選択行など）は失われる。
- **解決**: 親コンポーネント（`App.tsx`）に状態をリフトアップし、Props経由で渡すことで、タブを切り替えても状態を維持できる。 [+4]
