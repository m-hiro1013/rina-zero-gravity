%# 🧠 知見蓄積 (KNOWLEDGE)

## 🔄 データ構造の将来的な変更 (2026-02-17)
- **対象**: `toreta_data`
- **内容**: 現状は予約数と合算人数のみだが、今後は「ランチ/ディナー」を判別するためのパラメータ（フラグまたは個別カウント）を追加する予定。
- **影響**: 
    - 媒体別分析（食べログ・ホットペッパー）における「従量課金」の計算精度が向上する。
    - 実装済み：現在は `(ランチ単価 + ディナー単価) / 2` を合算客数に掛ける暫定ロジックを採用中。
    - 変更時：`ランチ客数 × ランチ単価 + ディナー客数 × ディナー単価` にロジックを切り替えること。

---
## 🧪 デバッグ・パースに関する知見 (2026-02-19)
- **根本原因の特定**: 一度修正に失敗した場合、あてずっぽうに修正を繰り返さず、必ず `console.log` でデータを可視化してデータ駆動でデバッグすること。
- **CSVパース (重要)**: 送信データ（TOON形式等）にJSONが含まれる場合、単純なカンマ分割や正規表現ではJSON内のカンマや引用符でデータが壊れる。
    - **解決策**: エスケープされた引用符 (`\"`) を考慮した一文字ずつのパースロジックを採用すること。
- **データ型の不一致**: `year_month` や `shop_code` などの識別子が「文字」と「数字」で混在すると比較が失敗する。
    - **解決策**: Parser の出口でこれら識別子を **String型に固定** し、後続の計算ロジックから型変換を排除すること。
- **プロトコル化**: 詳細は `.agent/rules/70-debugging-protocol.md` を参照。
