# 🧠 KNOWLEDGE.md - 知見蓄積メモ

## 🛠 技術スタック・ハマりどころ

### Tailwind CSS v4 + Vite
- **問題**: `tailwindcss` を PostCSS プラグインとして直接使うと、Vite v7 + Node v24 環境で `uv_cwd` エラーや PostCSS 警告が出ることがある。
- **解決**: `@tailwindcss/vite` をインストールし、`vite.config.ts` の `plugins` に `tailwindcss()` を追加する。
- **重要**: この場合、`postcss.config.js` の `plugins` 内にある `tailwindcss` 指定は空にする（競合を防ぐため）。

### React / TypeScript Data Handling
- **問題**: `202601` のような ID や日付データを `toon.txt` (YAML形式) から読み込む際、パーサーが数値（Number）として解釈し、UI側で `.substring()` 等の文字列メソッドが呼べずにクラッシュする。
- **解決**: UI 側のユーティリティ関数（`formatYM` 等）で `String(val)` による明示的なキャストと、空値ガードを徹底する。

## 🎨 デザイン・UI 設計

### Skeleton First 原則
- 最初から凝ったデザインを作らず、まずはサイドバーのナビゲーション、データ取得、期間選択などの「骨組み」を完成させる。
- メインコンテンツはプレースホルダーで「今何を表示しようとしているか」を可視化する。

### 期間選択のデフォルト値
- ユーザー体験向上のため、レポートのデフォルト表示期間は「最新月」から「1年前」を自動計算してセットする。
- `toon.txt` の `export_info.period.end` を基準点にする。

## 📍 プロジェクト特有のルール (new-world)
- **Source of Truth**: `sample/` フォルダ内の `sample.html`, `sample.css`, `sample.txt` が最終成果物の絶対的な指標。
- **実装順序**: 個別店舗 (Phase 2) -> 全店舗サマリー (Phase 3) の順で実装する。サマリーは個別データの集計になるため。

## 🧠 セッション知見 (2026-02-10)

### React Hooks の安全性
- **掟**: `useMemo`, `useEffect`, `useState` などの Hooks は、必ずコンポーネントの最上部、つまり **あらゆる `return` (早期リターン) よりも前に定義する** こと。 [+3]
- **理由**: Hooks の呼び出し順序が初期レンダリング時と異なると、React の内部状態が崩壊し `Uncaught Error: Rendered more hooks than during the previous render.` が発生する。

### ダッシュボードの整合性
- **設計**: メインコンテンツの最上部には、現在選択されている「店舗名」「店舗コード」「表示期間」を明示するヘッダーを設ける。 [+2]
- **効果**: 複雑なデータダッシュボードにおいて、ユーザーが「今何を見ているか」の迷子になるのを防ぎ、情報の信頼性を高める。

### 横並びタブによるナビゲーション
- **知見**: 情報量が多いページでは、垂直スクロールだけでなく、カテゴリ別の横並びタブ（売り上げ, 媒体別等）を導入することで、目的のデータへのアクセス速度が劇的に向上する。 [+2] (2026-02-10)
