# RPA開発フロー完全ガイド 🎯✨

> **このドキュメントは、RPAプロジェクトにおける開発の進め方を完全に定義したものです。**
> **全てのタスクは、この手順に従って進めてください。**

---

## 📋 目次

1. [基本原則](#基本原則)
2. [開発フローの全体像](#開発フローの全体像)
3. [Phase 1: Skill調査](#phase-1-skill調査)
4. [Phase 2: Test実験](#phase-2-test実験)
5. [Phase 3: Skill作成](#phase-3-skill作成)
6. [Phase 4: Workflow作成](#phase-4-workflow作成)
7. [ファイル管理ルール](#ファイル管理ルール)
8. [ドキュメント記載ルール](#ドキュメント記載ルール)
9. [禁止事項](#禁止事項)

---

## 基本原則

### 🎯 最優先事項

1. **Skill優先**: 全ての機能は、再利用可能なSkillとして実装する
2. **Test実験**: 動作確認はTestフォルダで行う（本番コードは書かない）
3. **【絶対厳守】プラン先出し**: 修正が必要な時は、コードを書く前に必ず「修正内容・メリット」をプランとして提示し、ひろきくんの **GOサイン** をもらう。自律判断による勝手な修正はガバナンス違反！
4. **BOOK.md 参照**: 案件着手前と完了後に必ず `BOOK.md` を読み、媒体別手順とデータ形式を同期する
5. **漏れダブり禁止**: 同じ機能を複数の場所に実装しない
6. **再利用前提**: SkillとWorkflowは、他のプロジェクトでも使えるように設計する
7. **【絶対厳守】スコープ・ロック**: 指示された修正範囲（関数・変数・ロジック）以外は、1行たりとも勝手に書き換えない。良かれと思った改善でも、範囲外ならまず提案にとどめる。
8. **完全文書化**: 全てのSkillとWorkflowには、詳細なコメントを記載する


---

## 開発フローの全体像

```
┌─────────────────────────────────────────────────────────────┐
│ やりたいことが発生                                          │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 1: Skill調査                                          │
│ - 該当する媒体フォルダのskillを探す                         │
│ - 使えるものと不足を確認                                    │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 2: Test実験                                           │
│ - testフォルダで動作確認のみ行う                            │
│ - 使えるskillを併用して、余計なものは作らない               │
│ - 正式なloopや条件分岐は書かない（動作確認のみ！）          │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 3: Skill作成                                          │
│ - 動作確認が完了したら、分解してskillを作成                 │
│ - 漏れダブり禁止（既存skillと重複しないように）             │
│ - testから削除                                              │
└─────────────────────┬───────────────────────────────────────┘
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 4: Workflow作成                                       │
│ - skillが必要分揃ったら、workflowの作成に入る               │
│ - 複雑な条件や照合可否を試す際はtestで行う                  │
│ - ただし実際の動作はskillで完結すること                     │
│ - workflow固有のものは作らない                              │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 1: Skill調査

### 🔍 目的

やりたいことを実現するために、既存のSkillが使えるか確認する。

### 📝 手順

1. **該当する媒体フォルダのskillを探す**
   ```
   例: hotpepper の場合
   → /Users/matsumotohiroki/Desktop/rina-zero-gravity/ZG_PROJECT/rpa/hotpepper/skill/
   ```

2. **既存Skillの一覧を確認**
   ```bash
   ls -la hotpepper/skill/
   ```

3. **各Skillファイルの冒頭コメントを読む**
   - 何ができるか
   - 何が必要か（事前準備、.envなど）
   - どう使うか

4. **使えるものと不足を確認**
   - ✅ 使えるSkill: そのまま使う
   - ⚠️ 不足しているSkill: Phase 2で実験して作成

### ✅ 完了条件

- 既存Skillで何ができるか把握できた
- 不足しているSkillが明確になった

---

## Phase 2: Test実験

### 🧪 目的

**動作確認のみ**を行う。本番コードは書かない。

### 🧪 手順

1. **testフォルダに実験用ファイルを作成**
   ```
   例: tests/test_experiment_xxx.py
   ```

2. **【超重要】最小データセットでの検証**
   - ❌ 10件、20件の全件テストは禁止（時間がかかりすぎる！）
   - ✅ 1〜2件の **「最小データセット」** でロジックを確認する。
   - ✅ 実環境への負荷と待ち時間を最小にする。

3. **【新】工程のスキップ活用**
   - 調査済みの「削除」などの重い工程は、テスト中はスキップ定数を設けるか、コメントアウトして効率化する。

4. **使えるskillを併用する**
   ```python
   # ✅ 正しい例
   from hotpepper.skill.auth import login
   from hotpepper.skill.navigation import navigate_to_drink
   
   async def test_experiment():
       # 既存skillを使って動作確認
       await login(page, LOGIN_ID, PASSWORD, BASE_URL)
       await navigate_to_drink(page)
       # 新しい操作を試す
       await page.click("#newButton")
   ```

3. **余計なものは作らない**
   - ❌ 新しいヘルパー関数を作らない
   - ❌ 新しいクラスを作らない
   - ✅ 既存skillを組み合わせて、最小限のコードで動作確認

4. **【新】確証のための原子テスト原則**
   - 複雑なループや分岐をいきなり回さない。
   - 「1件で成功する ＝ 操作ロジックが正しい」という確証を得る。
   - 「1, 2件で成功すれば、全件でも成功する」という確理を持ってから、次のステップへ進む。
   - 手順を原子レベル（要素特定、入力、クリック）に切り分けて、それぞれの「成功の確証」を積み上げる。

5. **使えるskillを併用する**

- **testでやりたいのは動作確認のみ**
- 正式なloopや条件分岐は、workflow作成時にやる
- まずはskillのテスト優先

### ✅ 完了条件

- 新しい操作が動作することを確認できた
- どのskillを作るべきか明確になった

---

## Phase 3: Skill作成

### 🛠️ 目的

動作確認が完了したら、分解してskillを作成する。

### 📝 手順

1. **testで確認した操作を分解**
   ```
   例: カテゴリー設定の操作
   → setup_headings() という1つのskillに分解
   ```

2. **漏れダブり禁止**
   - 既存skillと重複しないか確認
   - 同じ機能を複数の場所に実装しない

3. **skillファイルに実装**
   ```
   例: hotpepper/skill/category_ops.py
   ```

4. **冒頭に詳細なコメントを記載**（後述の「ドキュメント記載ルール」参照）

5. **testから削除**
   ```bash
   rm tests/test_experiment_xxx.py
   ```

### ✅ 完了条件

- 新しいskillが作成された
- 既存skillと重複していない
- testフォルダから実験用ファイルが削除された

---

## Phase 4: Workflow作成

### 🔄 目的

skillが必要分揃ったら、workflowの作成に入る。

### 📝 手順

1. **skillが必要分揃っているか確認**
   - 全ての操作がskillで完結するか
   - 不足しているskillがないか

2. **workflowファイルを作成**
   ```
   例: hotpepper/workflow/update_drink_menu.py
   ```

3. **複雑な条件や照合可否を試す際はtestで行う**
   ```python
   # 複雑な条件分岐がある場合
   # → testで動作確認してから、workflowに実装
   ```

4. **ただし実際の動作はskillで完結すること**
   ```python
   # ❌ NG: workflow内で新しい操作を書く
   async def workflow():
       await page.click("#newButton")  # これはskillにすべき
   
   # ✅ OK: skillを組み合わせる
   async def workflow():
       await login(page, ...)
       await navigate_to_drink(page)
       await setup_headings(page, headings)
   ```

5. **workflow固有のものは作らない**
   - workflowは、skillの組み合わせのみ
   - 新しい操作が必要なら、skillに分解

### ✅ 完了条件

- workflowが作成された
- 全ての操作がskillで完結している
- workflow固有の操作がない

---

## ファイル管理ルール

### 📁 ディレクトリ構成

```
/Users/matsumotohiroki/Desktop/rina-zero-gravity/ZG_PROJECT/rpa/
├── app.py                      # メインUI
├── hotpepper/                  # 媒体フォルダ
│   ├── skill/                  # 本番Skill（再利用可能）
│   │   ├── browser.py          # セッション管理
│   │   ├── auth.py
│   │   ├── ...
│   └── flow/                   # 本番Flow（Skillの組み合わせ）
│       ├── drink_update.py
│       └── ...
├── tests/                      # 実験用（進行中のタスクのみ）
│   ├── test_tXXX_xxx.py        # 命名規則: test_{タスクID}_{内容}.py
│   └── ...
└── prompt/
    └── WORKFLOW.yaml           # 進捗管理（テストトラッキング含む）
```

### 🗑️ 削除ルール

**testにあるのは進行中のタスクだけ**

1. **テスト作成時**: `WORKFLOW.yaml` のタスクに `test_files` を追記し、`cleaned: false` に設定。
2. **完了時**: 動作確認完了後、Skillに分解・Flowに統合。
3. **削除**: テストファイルを削除し、`WORKFLOW.yaml` の `cleaned` を `true` に更新。

---

## ドキュメント記載ルール

### 📝 Skillファイルの冒頭コメント

**全てのSkillファイルには、以下の情報を記載すること:**

```python
"""
[Skillの名前] - [簡潔な説明]

## 🎯 目的
このSkillが何をするか、なぜ必要かを説明

## 📋 機能一覧
- 機能1: 説明
- 機能2: 説明

## 🔧 事前準備
### 必要な環境変数（.env）
- `HOTPEPPER_LOGIN_ID`: ホットペッパーのログインID

### 必要なパッケージ
- playwright

## 💡 使い方
```python
from hotpepper.skill.xxx import function_name

# 使用例
await function_name(page, arg1, arg2)
```

## ⚠️ 注意事項
- 注意点1
- 注意点2

## 🔗 関連Skill
- `auth.py`: ログイン処理
"""
```

### 📝 Flowファイルの冒頭コメント

**全てのFlowファイルには、以下の情報を記載すること:**

```python
"""
[Flowの名前] - [簡潔な説明]

## 🎯 目的
このFlowが何をするか、どんな業務を自動化するか

## 📋 処理フロー
1. ステップ1: 説明
2. ステップ2: 説明

## 💡 使い方
```python
from hotpepper.flow.xxx import run

# app.py からの呼び出し
async for log in run(inputs):
    print(log)
```

## 🧩 使用しているSkill
- `browser.create_browser_session()`: セッション作成
- `drink_ops.update_drink_item()`: ドリンク更新

## ⚠️ 注意事項
- 注意点1
"""
```

---

## 禁止事項

### ❌ 絶対にやってはいけないこと

1. **Flow内に直接スキルを書く**
   - `page.click()` などの操作は全てSkillに入れること。
   - Flowは「手順（アルゴリズム）」のみを記述する。

2. **testに本番コードを書く**
   - testは動作確認のみ。

3. **同じ機能を複数の場所に実装する**
   - 漏れダブり禁止。既存Skillを確認すること。

4. **testを削除せずに終了する**
   - タスク完了時は必ずテストを一掃すること。

5. **ドキュメントを書かない**
   - 全てのSkillとFlowには詳細なコメントを記載すること。

6. **指示範囲外の勝手な編集**
   - 指示された箇所以外（特に関係なさそうなユーティリティや共通処理）を、推測や良かれと思って書き換えるのは厳禁。
   - デバッグ時の変数（カオス）を増やす原因になり、原因特定を遅らせる。

---

## チェックリスト

### ✅ Phase 1: Skill調査

- [ ] 該当する媒体フォルダのskillを探した
- [ ] 既存Skillの一覧を確認した
- [ ] 各Skillファイルの冒頭コメントを読んだ
- [ ] 使えるものと不足を確認した

### ✅ Phase 2: Test実験

- [ ] testフォルダに実験用ファイルを作成した（命名規則遵守）
- [ ] `WORKFLOW.yaml` にテストファイルを登録した
- [ ] 使えるskillを併用した
- [ ] 動作確認が完了した

### ✅ Phase 3: Skill作成

- [ ] testで確認した操作を分解した
- [ ] 既存skillと重複しないか確認した
- [ ] skillファイルに実装した
- [ ] 冒頭に詳細なコメントを記載した
- [ ] testから削除した

### ✅ Phase 4: Workflow作成

- [ ] skillが必要分揃っているか確認した
- [ ] flowファイルを作成した（`run(inputs)` 実装）
- [ ] 実際の動作はskillで完結している（直書き禁止）
- [ ] 冒頭に詳細なコメントを記載した

---

## まとめ

**このフローを徹底することで:**

1. ✅ **再利用性が高まる**: skillとflowは、他のプロジェクトでも使える
2. ✅ **保守性が高まる**: 同じ機能が複数の場所にないので、修正が簡単
3. ✅ **可読性が高まる**: 詳細なコメントがあるので、後から見てもわかる
4. ✅ **テストが簡単**: 動作確認はtestで行い、本番コードはskillで完結
5. ✅ **開発が速くなる**: 既存skillを組み合わせるだけで、新しい機能が作れる

**全てのタスクは、この手順に従って進めてください。**

