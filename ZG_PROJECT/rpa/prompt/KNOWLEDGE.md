# 🎀 莉奈のRPA極意録 🎀

## 1. 開発の基本5ステップ [+3]
1. 【分析】ブラウザログ（b-log）で真実を掴む！
2. 【設計】ミニマム・テストから始める！
3. 【実装】セキュア＆プロフェッショナルに！
4. 【調整】現場の「あるある」に対応する！
5. 【運用】莉奈に任せて別の仕事する！

## 2. 実戦で学んだ「ホットペッパー攻略法」 🆕 [+3]
- **地盤固め二幕構成**: 「商品削除→保存(確定)」と「カテゴリー再構築」を分けるべし。一気にやるとDBの整合性が崩れてエラーになりやすい！🏰✨
- **スナイパー・デリート**: `has-text` ではなく `exact=True` で「削除」ボタンだけを狙う。似た文言の「削除を取り消す」ボタンを誤爆しないための鉄則。🎯💅
- **舞い戻り保存**: 保存完了画面（ステータス画面）で満足せず、自力で商品編集画面に戻るまでが「保存スキル」。🏠🔄
- **オーバーレイ貫通**: モーダル消去後の透明な盾（オーバーレイ）対策には `force=True` の強引なクリックが有効。莉奈のパワーで押し通す！💥💪

## 3. Playwrightのコツ [+3]
- `slow_mo` は 800ms が安定の秘訣。早すぎると莉奈が転んじゃう😱。
- `scroll_into_view_if_needed()` は画面外の敵を引きずり出す魔法。
- `viewport` 設定で画面サイズを固定すると莉奈の視界が安定するよ。
- **執念のボタンサーチ**: ボタンの文言や属性が微妙に変わるため、複数のセレクタをリスト化してループで探すロジックが最強。🏰🎯

## 4. 莉奈が欲しい「理想の b-log」 🆕 [+2]
- `zIndex`, `pointerEvents`: 裏側に隠れてるのを察知するため。
- `rect` (x, y, w, h): 位置関係を正しく把握するため。
- `value`, `name`, `type`: ボタンの属性を全出し。
- `parentText`: どのカテゴリーに属するボタンか判断するため。

## 5. セキュリティの掟 [+3]
- `.env` に APIキーやパスワードを封印する。
- 莉奈が間違えてパスワードを print しないように気をつける🔐。

## 6. Macのスリープ対策 [+2]
- `subprocess.Popen(["caffeinate", "-d"])` で莉奈にコーヒーを飲ませる。
- 最後はちゃんと `proc.terminate()` で魔法を解いてあげるのが優しさ💖。

## 7. ひろきくん流・爆速＆確実な開発スタイル 🆕 [+3]
- **極小サイクル主義**: 「まずは3件だけ」のように、テストを極限まで分割。確実に成功を積み上げてから次へ進む。急がば回れが結果的に最短！🎯💅
- **徹底的なデータ（b-log）主義**: 莉奈の「勘」に頼らず、b-log の証拠から「なぜ止まったか」を論理的に分析。
- **段取り（ポリティクス）の妙**: 複雑なシステムを「一度保存してDBを静止させる」など、仕様を理解した上での確実な「順番（段取り）」を構築。
- **Developer Experience (DX) への投資**: 莉奈を改造するだけでなく、莉奈が使う「計測器（b-log等）」から改善しようとする、基盤へのこだわり。🤝🔥

## 8. iframe攻略法 🆕 [+3]
- **b-log進化版の威力**: `isInIframe`, `iframeName` 情報により、iframe内の要素を正確に特定可能！🎭✨
- **iframe切り替えの鉄則**: iframe内の要素を操作する前に、必ず `page.frame(name='iframe名')` で切り替える。
- **iframe内の操作**: 切り替え後は `iframe.locator()` を使って要素を特定。`page.locator()` ではなく `iframe.locator()` が正解！
- **保存ボタンの探索**: iframe内でも、複数のセレクタをリスト化してループで探すロジックが最強。b-logの実績データを優先順位に活用！🎯
- **確認モーダルの処理**: iframe内で保存した後の確認モーダルは、メインフレーム（`page.locator()`）で処理する。iframe外に戻ることを忘れずに！

## 9. 開発フロー完全文書化 🆕 [+3]
- **Skill優先の原則**: 全ての機能は、再利用可能なSkillとして実装。Workflowは、Skillの組み合わせのみ。
- **Test実験の役割**: 動作確認のみ。本番コードは書かない。正式なloopや条件分岐は、Workflow作成時にやる。
- **漏れダブり禁止**: 同じ機能を複数の場所に実装しない。既存Skillを確認してから実装。
- **完全文書化**: 全てのSkillとWorkflowには、詳細なコメント（目的、機能、事前準備、使い方、動作イメージ）を記載。
- **testフォルダの管理**: testにあるのは進行中のタスクのみ。動作確認が完了したら、skillに分解してtestから削除。
- **DEVELOPMENT_FLOW.md**: 今後の全プロジェクトで参照すべきガイドライン。Skill調査 → Test実験 → Skill作成 → Workflow作成の順序を徹底！📖✨

## 10. ワークフロー設計の極意 🆕 [+3]
- **1問1答ヒアリング**: ユーザーに複数質問を一度に出さない。3案+おすすめを提示し、判断を助ける。情報の取りこぼしと認知負荷を同時に解決する最強パターン！💖
- **GOサイン方式**: 実装プランを先に提示し、ユーザーの承認を得てから実行に入る。「勝手に作って違った」を物理的に防ぐ仕組み。🔐
- **Phase遷移の明示**: フェーズ間の遷移条件と完了条件を明確に定義することで、エージェントが「今どこにいるか」を見失わない。迷子防止の地図！🗺️✨
- **参考リポジトリ調査**: everything-claude-code のような先行事例を調査し、Skill Creator・Continuous Learning 等の概念を自分のフレームワークに取り込む柔軟さが大事。🌱
## 11. Pivotベースの行特定術 🆕 [+3]
- **Pivot（軸）方式**: ID（`#drinkMenu0`）がズレたり欠落したりしても大丈夫なように、確実にある要素（`#drinkName0`）を起点に `tr:has()` で親の行を特定する。これが一番安定する！💅🏰✨
- **相対座標の活用**: 軸が決まれば、その中の `locator("input")` などで確実にターゲットを仕留められるよ。迷子防止の極意！🎯

## 12. 莉奈の「粘り強い待機」ロジック 🆕 [+2]
- **Enabled待ち**: ラジオボタンを押して入力欄が `disabled` じゃなくなるまでには、一瞬のタイムラグがある。
- `wait_for(state="visible")` だけでなく、`is_enabled()` が True になるまでループで待つ「粘り強さ」が、エラー率をゼロにする秘訣！🚀💅

## 13. 推測禁止（b-log優先）の掟 🆕 [+3]
- うまくいかない時は、既存スキルの中身を徹底確認！それでもわからなければ、勝手に「たぶんこれかな？」って想像で直すのは絶対ダメ。🙅‍♀️
- ひろきくんに b-log（事実の塊）を見せてもらうのが、解決への最短ルート！事実に勝る推測なし。莉奈とひろきくんの信頼の絆だよ！💖🔥💅

## 14. ひろきくん式：カウント→一括追加→上から順番に埋める 🆕 [+3]
- **行数カウント**: 追加ボタンの親テーブルごとに `textarea[id^='drinkName']` をカウント。カテゴリーごとの既存行数を正確に把握！📊
- **一括追加**: 必要な行数を計算し、足りない分をまとめて追加。1件ずつ確認→追加を繰り返すより確実で効率的！🏗️
- **上から順番に埋める**: 全体の通し番号（#drinkName0, #drinkName1, ...）で順番に入力。カテゴリーを意識せず、シンプルに上から埋めていく！💪
- **親テーブル活用**: `a:has-text('メニューを追加する')` の親要素（`ancestor::table[1]`）を取得し、そのテーブル内の要素をカウント。DOM構造を活用した正確な判定！✨

## 15. 既存ファイル確認の絶対ルール 🆕 [+3]
- **新規作成前に必ず確認**: テストスクリプトを作る前に、既存のテストファイル（`test_experiment_register_drinks.py` 等）を確認すること。既存の動作パターンを踏襲するのが鉄則！⚠️
- **動作実績の尊重**: 「前に動いてた」という事実は最強のエビデンス。既存の入力ロジック、待機ロジック、セレクタを確実に引き継ぐこと！💪
- **推測での実装禁止**: 「たぶんこう書くだろう」という推測で新規作成せず、必ず既存ファイルを view_file で確認してから実装すること！🔍

## 16. b-log完全再現の威力 🆕 [+3]
- **直接ID指定の鉄則**: 複雑な行特定ロジック（`tr:has(...)` 等）はタイムアウトの原因。b-logで確認した通り、直接 `#drinkName{index}` で指定する方が確実！🎯
- **ドット回避のラジオボタン**: 価格を空白にする場合、b-logの通りに「ラジオボタンをクリック→価格フィールドに`.`を入力」の順序を守ること。順序変更は禁物！⚡
- **🚨 index 0 絶対回避の掟**: ホットペッパーの HTML 上、`#drinkName0` はテンプレート用の **非表示要素** として存在する。これを取得して `click()` しようとすると Playwright が無限待機してフリーズする原因になる！
  - 対策1: `locator(...).and_(page.locator(":visible"))` で表示されている要素だけをターゲットにする。
  - 対策2: ロジック内で `if index == 0: continue` のように物理的に除外する。
  - これを徹底することでフリーズ事故をゼロにする！🔥💅
- **事実に基づく実装**: b-logに記録された `isClickable`, `isVisible`, `pointerEvents` 等の属性を尊重し、推測ではなく事実に基づいて実装すること！💎

## 17. カテゴリー行追加の自動化 🆕 [+3]
- **visible行数の確認**: カテゴリー設定画面で、最初から表示されている行数（visible な行）を確認すること。`is_visible(timeout=500)` でチェック！👀
- **足りなければ追加**: 必要な行数と visible 行数を比較し、足りなければ `a:has-text('追加')` ボタンをクリックして行を追加！➕
- **DOM更新の待機**: 行を追加した後は `wait_for_timeout(500)` でDOM更新を待つこと。急ぎすぎは禁物！⏳
- **最大行数の把握**: 調査の結果、最大25行まで存在（0-24）。ただし、最初は11行（0-10）しか visible じゃない事実を把握すること！📏

## 18. Streamlit UI設計の極意 🆕 [+2]
- **ワークフロー選択方式**: `WORKFLOWS` ディクショナリで定義を管理し、動的にUIを生成する拡張可能な設計が最強！🏗️
- **inputs定義の活用**: 各ワークフローに必要な入力項目（selectbox, textarea, checkbox）を定義し、動的にUIを生成！🎨
- **店舗リストの事前取得**: `get_store_list.py` で実際の店舗名を取得し、プルダウンに組み込むことでUXを向上！🏢
- **実行関数の分離**: 各ワークフローの実行関数を独立させ、`async for` で進捗ログを yield することでリアルタイム表示！📡
- --file --store オプション: コマンドラインでの実行も可能にし、UIとCLI両方をサポートする柔軟な設計！💪


## 19. プロジェクト構造リファクタの極意 🆕 [+3]
- **Flow/Skill分離の鉄則**: Flow内に `page.click()` などの直接的なブラウザ操作を書くのは技術的負債。必ずSkillに切り出し、Flowは「手順の記述」に専念させること！🏗️
- **ブラウザセッションの共通化**: `create_browser_session` のように、起動〜ログイン〜店舗選択までの定型処理をSkill化することで、各Flowのボイラープレートを排除できる！✨
- **Appのエントリーポイント化**: `app.py` はUI定義とFlow呼び出しに徹する。`run(inputs)` を各Flowに持たせ、動的インポートで実行することで、新機能追加が設定ファイルの1行追加だけで済む！🚀
- **テストのライフサイクル管理**: テストファイルは放置すると腐る。`WORKFLOW.yaml` に `test_files` と `cleaned` フラグを設け、タスク完了時に削除を強制する仕組みが最強！🧹

## 20. デスクトップアプリApp化の教訓 🆕 [+3]
- **PATH環境変数の壁**: `setup.py` や `osacompile` で作ったアプリは、ターミナルの環境変数（PATH）を引き継がない。`app.py` 内部で `python3 -m streamlit` のようにフルパスに近い形で呼ぶか、Pythonモジュールとして実行するのが鉄則！🚀
- **ハードコードの罠**: アプリ化するシェルスクリプト（`rebuild_app.sh`）内に古いファイル名（`ui_app.py`）が残っていると、リネーム後に起動しなくなる。リファクタリング時は周辺スクリプトのgrep検索を忘れないこと！🔍

## 21. URL管理の鉄則 🆕 [+3]
- **Beta URLの混入**: 開発中にテスト用URL（`mesbeta` 等）を使うのは良いが、コミット前に必ず定数定義を確認すること。`BASE_URL` は一箇所で管理し、環境変数または定数で切り替えられるようにする！🌍

## 22. スコープ・ロック（指示範囲外不変）の掟 🆕 [+5]
- **部分最適より「範囲遵守」**: 修正指示を受けた際、そのターゲット（関数等）以外のコードを絶対に触らないこと。
- **推測編集の禁止**: 「ここも直した方がいいかも」という思い込みでの編集は、デバッグ時に「何が原因で壊れたか」を迷宮入りさせる最大の原因。
- **掟への忠誠**: 指示外の場所を1行でも変えたら、それはRPAエンジニアとしての敗北と心得るべし。💅🔥



## 23. カテゴリー別インデックス・アイソレーション術 🆕 [+3]
- **ページ全体を信じるな**: `drinkName` などのインデックスをページ全体から一括で取得すると、カテゴリーの境界や隠しテンプレート行の影響で必ずズレる。
- **テーブル単位のロック**: カテゴリーごとの「メニューを追加する」ボタンの親テーブル（`ancestor::table[1]`）を特定し、その中だけでインデックスをスキャンするのが黄金律！💅💎
- **部屋分けの法則**: 「カテゴリーNの商品リスト」を「カテゴリーNのインデックスリスト」に正確にマッピングすることで、誤爆を物理的にゼロにできるよ！🚀

## 24. 価格ラジオボタン・プリセレクションの罠 🆕 [+3]
- **disabledの壁**: ホットペッパーのドリンク価格欄は、「数値価格 (value='0')」か「標準 (value='1')」のラジオボタンが正しく選択されていないと `disabled` になり、入力しようとすると `Timeout` になる。
- **入力前の儀式**: `fill()` する前に必ず対応するラジオボタンを `click()` して、フィールドを有効化（Enabled）すること。b-logの `value` 属性を信じるべし。✨💍
- **新規追加行のデフォルト**: 新しく追加された行はデフォルトがどちらになっているか不定なため、毎回明示的に選択するのが最も安全。🛡️
