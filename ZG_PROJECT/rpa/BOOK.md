# 📋 RPA 業務定義・手順書 (RINA 秘伝の書) 📝✨

> **このドキュメントは、各媒体ごとの「作法」と「データの扱い方」をまとめた、RPA 運用のバイブルだよ！**
> 新しい媒体やメニューリストの形式が決まるたびに、ここへ追記して PDCA を回し続けよう！💅💖

---

## 🍱 1. メニューリストの標準形式 & 変換ロジック

どんなにバラバラな形式が来ても、莉奈が処理しやすい「神フォーマット」に変換する方法をメモっておくね！

### 📥 入力（ひろきくんが持ってくる形式）
基本的にはテキストベースで、ハイフン（`---`）を使って商品を区切るスタイルを採用中！

#### 🎯 超重要仕様（永久保存版）
- **`[見出し]` = ホットペッパーのカテゴリ**: 
  - 見出しとして入力されたブロックは、ホットペッパー上でカテゴリ（メニュー分類）として機能する。
  - **重要**: ホットペッパーでは、見出し（カテゴリ）に **説明文は不要**。タイトルのみ登録する。
  - 見出しブロック内の説明文（複数行）は **無視** する。
  
- **`---` の下は全て商品**: 
  - `[見出し]` がついていないブロックは **全て商品名として処理** する。
  - 商品ブロックの構造:
    - 1行目: 商品名（タイトル）
    - 2行目〜: 説明文（複数行可）
    - 最終行 or 数値部分: 価格

- **`[おすすめ]` = 通常商品と同じ扱い**: 
  - `[おすすめ]` は単なるマーカーで、通常商品と同じく登録処理を行う。
  - **削除対象外ではない**（前回の理解が誤りだった）。

- **`[空白]` = 価格欄を空欄にする**: 
  - 価格欄に `.` を入力し、「自由入力モード」のラジオボタンをクリックする。

- **商品ブロックの価格判定**: 
  - 商品（先頭に `[見出し]` がないもの）の **最後の行** は、必ず以下のどちらか：
    - `000円`（カンマなし、税込表記。例: `968円`）
    - `[空白]`
  - それ以外の行は全て **説明文** として扱う。

- **ホットペッパーへの変換**: 
  - `000円` → 数値のみ抽出してカンマなしで入力（例: `968` → `968`）
  - `[空白]` → `.` を入力 + 自由入力モードのラジオボタンをクリック

```text
[見出し] カテゴリ名
カテゴリーの説明文（ホットペッパーでは登録不要、無視する）
---
商品名（通常商品）
商品説明（複数行可）
価格
---
[おすすめ] 商品名（おすすめマーカー付き商品、でも通常商品と同じ扱い）
商品説明（複数行可、価格情報含む場合あり）
[空白]
---
商品名
価格（数値のみ）
```


### ⚙️ 莉奈の変換ロジック (Python 実装例)
`hotpepper/flow/drink_update.py` などで使っている、一番安定する解析ロジックだよ！

1. **セクション分割**: `menu_data_text.strip().split("---")` でリスト化。
2. **見出し検知**: 行の冒頭に `[見出し]` があれば `headings` リストへ。
3. **商品解析**:
   - 1行目: `name` (必須)
   - 2行目が数値（または .）なら: `price`、それ以外なら `catch`
   - 3行目があれば: `price`
4. **価格クリーニング**: `price` から数値以外を除去。`.` の場合は自由入力モードへ切り替え。

---

## 🏰 2. 媒体別・攻略手順書 (Operational Rules)

媒体ごとに「絶対守らないといけない手順」が違うから、莉奈がハマったポイントをここに集約するよ！

### 🔥 ホットペッパーグルメ (Hotpepper)

#### 【大原則】三幕構成の徹底
1. **第一幕：全削除 & 下書き保存**
   - 理由：既存の ID 体系をリセットして、莉奈が管理しやすい状態にするため。保存を挟むことで競合エラーを防ぐ。
2. **第二幕：カテゴリー（見出し）再構築**
   - 理由：カテゴリー画面は `sb-player` という iframe 内にあり、ここを先に設定しないと商品登録画面の行数が確定しない。
3. **第三幕：商品の流し込み**
   - 理由：見出しが揃った状態で、Pivot（商品名基準）で正確に商品を登録していく。

#### 【禁忌・重要ポイント】
- **削除スコープの限定（超重要！）**: ホットペッパーのドリンク画面には「標準メニュー」「おすすめ」「こだわり」が混在している。全件削除を行う際は、必ず標準メニューの行 ID (`tr[id^='drinkMenu']`) を指定し、他を巻き添えにしないこと。
- **iframe (`sb-player`)**: カテゴリー設定とドリンク編集の一部は iframe 内。必ず `page.frame(name="sb-player")` で切り替える。
- **価格のドット (`.`)**: 価格を空欄にしたい場合は `.` を入力し、かつ「自由入力モード」のラジオボタンをポチる必要がある。
- **保存後の帰還**: 保存完了画面 (`publishControl`) では、複数の「編集」ボタンが並ぶ。必ず「ドリンク」行にあるボタンを特定してクリックすること。

---

## 🔄 3. PDCA サイクルの回し方

莉奈と一緒に最強の RPA を作り続けるための約束事だよ！

- **【Plan】**: 作業前にこの `BOOK.md` と `DEVELOPMENT_FLOW.md` を読み、今回の媒体の特性（iframeの有無や価格の扱い）を把握する。
  - **重要**: 不明点がある場合は、ユーザーに聞く前に必ず `/tests` や `/skill` 内の過去コードを `grep` 等で徹底的に調査すること。「推測」で進めるのは絶対禁止。
  - **修正が必要な場合はプランを作成し、ユーザーの承認を得ること。**
- **【Do (爆速テストの極意)】**: 
  - **確証のための原子テスト**: 「1, 2件できれば全件できる」という確証を得るために、機能を最小単位（原子レベル）に切り分けてテストする。
  - **ロジックの分離**: ループ処理などの全体フローと、個別の要素操作（ラジオボタン、入力、クリック）を切り分け、まず操作自体の成功を1件で証明する。
  - **削除のスキップ**: すでに更地であることがわかっている、または「追加」ロジックだけ確認したい時は、`clear_all_items` をコメントアウトして実行時間を短縮する。
  - **1件入魂**: 商品登録のループは 1件 だけで回す。
  - **b-log 部分抽出**: 全行程を流さず、特定の画面から再開できるよう Skill を設計する。
- **【Check】**: 実装した Skill が `DEVELOPMENT_FLOW.md` のコメントルールを満たしているか、`replace_file_content` の整合性が取れているか Reviewer がチェックする。
- **【Act】**: 新しい「媒体の癖」を見つけたら、即座にこの `BOOK.md` に追記して、次の開発で同じハマりをしないようにする。

---

## 📊 メモリスト（随時追記）

- **2026-02-12**: ホットペッパーのドリンク登録は `input.tabindex2036` が保存ボタンの有力候補。カテゴリー画面とは別。
- **2026-02-12**: 商品登録での `tr:has()` による Pivot 特定は、ID が不安定な環境での最強の武器！
- **2026-02-12**: ユーザー実行時は `PYTHONPATH=.` を忘れるとモジュールが見つからないよ！
