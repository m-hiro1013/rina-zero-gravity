# Knowledge base

- 2026-02-26: [Protocol] **仕様書の嘘（乖離）への対処**: LZH形式/UTF-8の指示に対し、ZIP/Shift-JISの実態を発見。いきなり本実装せず「調査スクリプト」でマジックバイト(PK)やデコードエラーを検証することが重要。 [+10]
- 2026-02-26: [Python] **ftplib encoding**: 日本の古いサーバーは `ftp.encoding = 'cp932'` を接続直後に設定しないと、挨拶文で `UnicodeDecodeError` になる可能性がある。 [+7]
- 2026-02-26: [Infrastructure] **FTP一覧制限と保持期間**: サーバー側で1000件の表示制限がある。現在のデータ量は「1日20件」で、ちょうど50日分の **2026-01-05** まで遡れることを確認。これを過ぎるとアルファベット順（店舗CD順）の打ち切りにより最新データが見えなくなるリスクがあるため、ワイルドカード取得か定期削除が必須。 [+8]
- 2026-02-26: [Data Engineering] **コードと名前の1対多/多対1問題**: POSデータなど店舗が各自でレジ設定できる環境では、メニューコードや部門コードが完全に重複・再利用される。したがって、「コード」のみを主キーに集計するとデータが混ざって崩壊する。必ず「店舗CD」や「業態」を複合したユニークキーとし、監査スクリプト（Pythonで生データ一括検査）を通すことが不可欠。 [+9]
- 2026-02-27: [Architecture] **他プロジェクトのマスター直接参照の極意**: データの二重管理は負債の元になる。GASから別プロジェクトのマスタースプレッドシートを `SpreadsheetApp.openById()` で直接ルックアップ（今回は `getShopCategoryMap`）する設計が美しく、最もメンテコストが低い。ただし初回の権限承認フローがある点だけ要注意。 [+10]
- 2026-02-27: [UI/UX] **マスターデータの表記ゆれ防止**: マスター入力画面において分類（業態など）を入力させる際、テキスト入力ではなく`select`タグによる固定リストを提供することで、後のテーブル結合やGROUP BYでの分散（Asian / アジアン問題）を完全に防止できる。基本のデータ設計原則。 [+8]
