# POS分析ダッシュボード 実装プラン

> 作成日: 2026-02-27
> ステータス: プラン策定中

---

## 1. ゴール

GASの `doGet` で HTML 1ページを返す、**全店舗の月間POSデータ分析ダッシュボード**を構築する。

- **データ重視**: 今回は正しいデータ構造と集計ロジックが最優先
- **見た目はシンプル**: 後でReact化する際にこだわるので、今回はテーブルベースでOK
- **対象月**: 年月（YYYYMM）を指定して表示（クエリパラメータ or セレクト）

---

## 2. データソース

### 2.1 商品出数管理シート（集計済み）
| カラム | 用途 |
|:---|:---|
| 業態 | フィルタ・グルーピング |
| 店舗CD | フィルタ・グルーピング |
| **部門名称** | **大カテゴリ（フード/ドリンク/テイクアウト/サブフード/サブドリンク/SP）** |
| **分類名称** | **小カテゴリ（ランチ/BEER/ランチコース/飲み放題 etc.）** |
| ﾒﾆｭｰCD | 商品ID |
| ﾒﾆｭｰ名称 | 商品名 |
| 年月 | YYYYMM |
| 売価(税込) | 単価（集計には使わず参考値） |
| 売価(税抜) | 単価（集計には使わず参考値） |
| 原価 | 原価（集計には使わず参考値） |
| **販売数** | **出数（集計のメイン対象）** |

### 2.2 曜日・時間帯別傾向シート（集計済み）
| カラム | 用途 |
|:---|:---|
| 店舗CD | フィルタ |
| ﾚｼｰﾄNo | ユニーク会計識別 |
| 年月 | YYYYMM |
| 日付 | DD |
| **曜日** | **曜日別売上の集計キー** |
| **is_holiday** | **祝日判定（1=祝日/土日, 0=平日）** |
| **オーダー日時** | **来店時間（HH:mm:ss） → 時間帯判定** |
| 会計日時 | 退店時間 |
| **会計金額** | **1会計の合計売上** |

---

## 3. 表示セクション（HTML上の構成）

### 3.1 ヘッダー
- 対象年月の表示（例: 2026年2月）
- 全体の総売上金額

### 3.2 セクション①: 時間帯別売上
**来店時間（オーダー日時のHH部分）で3区分**:

| 区分 | 時間帯 | 判定ロジック |
|:---|:---|:---|
| ランチ | 11:00〜14:59 | HH >= 11 && HH < 15 |
| アイドル | 15:00〜16:59 | HH >= 15 && HH < 17 |
| ディナー | 17:00〜 | HH >= 17 |
| その他 | 〜10:59 | HH < 11（早朝・仕込みなど） |

**表示内容**:
- 各時間帯の会計件数
- 各時間帯の売上金額
- 構成比（%）

### 3.3 セクション②: 曜日別売上
**曜日 + 祝日で集計**:

| グループ | 判定ロジック |
|:---|:---|
| 月〜金（平日） | is_holiday == 0 && 曜日 in [月,火,水,木,金] |
| 土 | 曜日 == "土" && is_holiday == 1 |
| 日 | 曜日 == "日" && is_holiday == 1 |
| 祝日 | is_holiday == 1 && 曜日 in [月,火,水,木,金]（**平日の祝日のみ別カウント**） |

**表示内容**:
- 各曜日の会計件数
- 各曜日の売上金額合計
- 1日あたり平均売上（営業日数で割る）

### 3.4 セクション③: フード・ドリンク売上比率
**部門名称で集計**:

| カテゴリ | 対象部門名称 |
|:---|:---|
| フード | "フード", "サブフード" |
| ドリンク | "ドリンク", "サブドリンク" |
| テイクアウト | "テイクアウト" |
| その他 | "SP" 等 |

**集計方法**:
- 販売数 × 売価(税込) = 売上金額 を部門ごとに合算
- 全体の売上に対する構成比（%）を算出

**表示内容**:
- フード売上 / ドリンク売上 / テイクアウト売上 / その他
- 各構成比（%）

### 3.5 セクション④: コース売上比率
**分類名称に「コース」または「飲み放題」を含むものを抽出**:

**判定ロジック**:
```
分類名称.includes("コース") || 分類名称.includes("飲み放題")
```

**表示内容**:
- コース全体の売上金額
- 全体売上に対するコース構成比（%）
- コース名ごとの集計テーブル:
  - コース名（ﾒﾆｭｰ名称）
  - 販売数
  - 売上金額
  - コース全体に対する構成比（%）
- **並び順**: 販売数の多い順（降順）

### 3.6 セクション⑤: 商品出数ランキング（カテゴリ別）
**部門名称（大カテゴリ）→ 分類名称（小カテゴリ）→ 商品の階層構造**:

```
フード（大カテゴリ）
├── ランチ（小カテゴリ） - 構成比 XX%
│   ├── L)ガパオ＆グリーンカレー - 121個 (XX%)
│   ├── L)海鮮パッタイ - 98個 (XX%)
│   └── ...
├── メイン料理（小カテゴリ） - 構成比 XX%
│   ├── トムヤムクン - 45個 (XX%)
│   └── ...
└── ...

ドリンク（大カテゴリ）
├── BEER（小カテゴリ）
│   └── ...
└── ...
```

**並び順ルール**:
1. **大カテゴリ**: 構成比が大きい順
2. **小カテゴリ**: 所属する商品の合計販売数が大きい順
3. **商品**: 販売数が大きい順

**表示内容**:
- 大カテゴリ名 + 合計販売数 + 構成比
- 小カテゴリ名 + 合計販売数 + 構成比
- 商品名 + 販売数 + 構成比

**除外**: コース関連（セクション④で別集計するため）は除外 or 含めるかはひろきくん判断

---

## 4. GASファイル構成

### 4.1 新規ファイル
| ファイル | 役割 |
|:---|:---|
| `gas/dashboard.gs` | doGet + データ取得 + 集計ロジック |
| `gas/dashboard.html` | HTMLテンプレート（1ファイルに全部入れる） |

### 4.2 `dashboard.gs` の関数構成

```javascript
// エントリポイント
function doGet(e) {
  // クエリパラメータ ?ym=202602 で年月指定
  const ym = (e && e.parameter && e.parameter.ym) || getCurrentYM();
  const template = HtmlService.createTemplateFromFile('dashboard');
  template.data = buildDashboardData(ym);
  return template.evaluate().setTitle('POS分析ダッシュボード');
}

// メインのデータ構築関数
function buildDashboardData(ym) {
  return {
    ym: ym,
    timeslot: buildTimeslotData(ym),     // 時間帯別売上
    weekday: buildWeekdayData(ym),       // 曜日別売上
    foodDrink: buildFoodDrinkRatio(ym),  // フード・ドリンク比率
    course: buildCourseData(ym),         // コース集計
    ranking: buildItemRanking(ym),       // 商品出数ランキング
    totalSales: totalSalesAmount,        // 全体売上
  };
}

// 時間帯別売上の集計
function buildTimeslotData(ym) { ... }

// 曜日別売上の集計
function buildWeekdayData(ym) { ... }

// フード・ドリンク比率の集計
function buildFoodDrinkRatio(ym) { ... }

// コース売上の集計
function buildCourseData(ym) { ... }

// 商品出数ランキング（カテゴリ階層）の集計
function buildItemRanking(ym) { ... }
```

### 4.3 `dashboard.html` の構成

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>POS分析ダッシュボード</title>
  <style>
    /* シンプルなテーブルスタイル（最低限） */
  </style>
</head>
<body>
  <h1>POS分析ダッシュボード - <?= data.ym ?></h1>
  
  <!-- セクション①: 時間帯別売上 -->
  <!-- セクション②: 曜日別売上 -->
  <!-- セクション③: フード・ドリンク比率 -->
  <!-- セクション④: コース集計 -->
  <!-- セクション⑤: 商品出数ランキング -->
</body>
</html>
```

---

## 5. 実装ステップ

| Step | 内容 | 対象ファイル |
|:---|:---|:---|
| 1 | `dashboard.gs` のスケルトン作成（doGet + データ取得基盤） | gas/dashboard.gs |
| 2 | 時間帯別売上の集計ロジック実装 | gas/dashboard.gs |
| 3 | 曜日別売上の集計ロジック実装 | gas/dashboard.gs |
| 4 | フード・ドリンク比率の集計ロジック実装 | gas/dashboard.gs |
| 5 | コース売上の集計ロジック実装 | gas/dashboard.gs |
| 6 | 商品出数ランキングの集計ロジック実装 | gas/dashboard.gs |
| 7 | `dashboard.html` のテンプレート作成（全セクション） | gas/dashboard.html |
| 8 | GASにデプロイ＆動作確認 | GASエディタ |

---

## 6. 確認事項（ひろきくんに聞きたいこと）

1. **コースの判定方法**: `分類名称` に「コース」「飲み放題」が含まれるもの、で合ってる？
   - それとも `部門名称` や `ﾒﾆｭｰ名称` ベースの方がいい？

2. **商品出数ランキングからコースは除外？**: セクション④でコースを別集計するので、セクション⑤からは除外した方がスッキリする？

3. **売上金額の計算**: `販売数 × 売価(税込)` で合ってる？ それとも曜日・時間帯別傾向シートの `会計金額` を使う？
   - 時間帯別・曜日別 → 会計金額（レシート単位の合算値）
   - フード・ドリンク比率・商品ランキング → 販売数 × 売価(税込)（商品単位）

4. **全店舗合算？ それとも店舗ごと？**: 今回は全店舗合算のダッシュボード？店舗フィルタは後でReact版で？

5. **is_holiday の祝日判定**: 現状はis_holiday=1が「土日 OR 祝日」になってる。
   - 祝日を土日と分離するには、`曜日が月〜金 && is_holiday=1` で祝日を抽出する必要がある
   - 土曜は `曜日==土`、日曜は `曜日==日` で分離 → これでOK？

---

## 7. 未決定事項

- [ ] コース判定ロジックの確定（確認事項 #1）
- [ ] 商品ランキングからのコース除外 or 含む（確認事項 #2）
- [ ] 店舗フィルタの有無（確認事項 #4）
