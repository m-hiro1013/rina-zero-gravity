<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOON World Analyzer</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom Styles -->
    <?!= include('styles'); ?>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">

    <div id="app" class="min-h-screen pb-20 transition-all">

        <!-- Loading Overlay -->
        <div v-if="isLoading"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <div class="loader mx-auto mb-4"></div>
                <p class="text-lg font-bold text-gray-700">{{ loadingText }}</p>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-white shadow-sm mb-6 sticky top-0 z-30">
            <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-blue-600 flex items-center gap-2 cursor-pointer"
                        @click="resetAll">
                        üìä TOON World Analyzer
                    </h1>
                </div>

                <!-- Header Actions (Visible Step 2 & 3) -->
                <div v-if="step > 1" class="flex items-center gap-4">
                    <!-- Download Button (Visible in Step 3) -->
                    <button v-if="step === 3" @click="downloadReport"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 font-bold text-sm transition flex items-center gap-2">
                        üíæ „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                    </button>

                    <!-- Back to Settings (Visible in Step 3) -->
                    <button v-if="step === 3" @click="backToSettings"
                        class="text-sm text-gray-500 hover:text-gray-700 underline">
                        Ë®≠ÂÆö„Å´Êàª„Çã
                    </button>

                    <!-- Back to Start (Visible in Step 2) -->
                    <button v-if="step === 2" @click="resetAll"
                        class="text-sm text-gray-500 hover:text-gray-700 underline">
                        „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Å´Êàª„Çã
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto px-4">

            <!-- STEP 1: File Drop Zone -->
            <div v-if="step === 1"
                class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-16 text-center cursor-pointer transition transform hover:scale-[1.01] hover:border-blue-500 hover:bg-blue-50 mt-10"
                @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @drop="handleDrop"
                @click="$refs.fileInput.click()">

                <div class="text-6xl mb-6">üìÅ</div>
                <p class="text-2xl font-bold mb-2 text-gray-700">TOON„Éï„Ç°„Ç§„É´„Çí„Åì„Åì„Å´„Éâ„É≠„ÉÉ„Éó</p>
                <p class="text-sm text-gray-400">„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû (.toon, .txt)</p>
                <input type="file" ref="fileInput" class="hidden" accept=".toon,.txt" @change="handleFileSelect">
            </div>

            <!-- STEP 2: Settings -->
            <div v-if="step === 2" class="max-w-3xl mx-auto animate-fade-in-up">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">üìÇ „É¨„Éù„Éº„ÉàÁîüÊàêË®≠ÂÆö</h2>

                <div class="bg-white rounded-lg shadow p-6 space-y-8">

                    <!-- Period Setting -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ÊúüÈñìÔºàÈñãÂßãÔºâ</label>
                            <input type="number" v-model="periodStart"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                placeholder="YYYYMM">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ÊúüÈñìÔºàÁµÇ‰∫ÜÔºâ</label>
                            <input type="number" v-model="periodEnd"
                                class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-blue-500"
                                placeholder="YYYYMM">
                        </div>
                    </div>

                    <!-- AI Options -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">„Ç™„Éó„Ç∑„Éß„É≥</label>
                        <label
                            class="flex items-center gap-2 cursor-pointer bg-blue-50 px-4 py-3 rounded-lg hover:bg-blue-100 transition border border-blue-100">
                            <input type="checkbox" v-model="aiEnabled"
                                class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                            <div>
                                <span class="font-bold text-blue-800 flex items-center gap-1">‚ú® AIÂàÜÊûê„É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åô„Çã</span>
                                <span class="text-xs text-blue-600 block mt-1">Gemini
                                    AI„Çí‰ΩøÁî®„Åó„Å¶„ÄÅÂÖ®‰Ωì„Çµ„Éû„É™„Éº„Å®Â∫óËàóÂà•„Ç≥„É°„É≥„Éà„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ</span>
                            </div>
                        </label>
                    </div>

                    <!-- Shop Selection -->
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <label class="block text-sm font-bold text-gray-700">ÂØæË±°Â∫óËàó„ÇíÈÅ∏Êäû</label>
                            <button @click="toggleAllShops" class="text-xs text-blue-600 hover:underline">
                                {{ selectedShops.length === availableShops.length ? '„Åô„Åπ„Å¶Ëß£Èô§' : '„Åô„Åπ„Å¶ÈÅ∏Êäû' }}
                            </button>
                        </div>
                        <div
                            class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 max-h-60 overflow-y-auto border border-gray-200 rounded p-4 custom-scrollbar">
                            <label v-for="shop in availableShops" :key="shop.code"
                                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded">
                                <input type="checkbox" v-model="selectedShops" :value="shop.code"
                                    class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                <span class="text-sm">{{ shop.name }}</span>
                            </label>
                        </div>
                        <p class="text-right text-xs text-gray-500 mt-1">{{ selectedShops.length }} / {{
                            availableShops.length }} Â∫óËàóÈÅ∏Êäû‰∏≠</p>
                    </div>

                    <!-- Action Button -->
                    <div class="pt-4 border-t flex justify-end">
                        <button @click="generateReport" :disabled="selectedShops.length === 0"
                            class="bg-blue-600 text-white px-8 py-3 rounded-lg shadow-lg hover:bg-blue-700 font-bold text-lg transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                            „É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åô„Çã üöÄ
                        </button>
                    </div>
                </div>
            </div>

            <!-- STEP 3: Report View -->
            <div v-if="step === 3" class="space-y-8 animate-fade-in-up">

                <!-- Overall Summary (AI) -->
                <div v-if="aiEnabled"
                    class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500 relative min-h-[100px]">
                    <h2 class="text-lg font-bold mb-3 text-gray-800 flex items-center gap-2">
                        <span>ü§ñ</span> ÂÖ®‰Ωì„Çµ„Éû„É™„Éº
                        <span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full">Gemini 2.5
                            Flash</span>
                    </h2>

                    <div v-if="aiSummary.loading" class="flex items-center gap-2 text-gray-500 italic py-4">
                        <div class="loader w-5 h-5 border-2"></div> ÂàÜÊûê‰∏≠...
                    </div>

                    <div v-else-if="aiSummary.error" class="text-red-500 py-2">
                        ‚ùå „Ç®„É©„Éº: {{ aiSummary.error }}
                    </div>

                    <div v-else-if="aiSummary.content"
                        class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">
                        {{ aiSummary.content }}
                    </div>

                    <div v-else class="text-gray-400 text-sm py-2">
                        „Éá„Éº„Çø„ÅÆÂàÜÊûê„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü...
                    </div>
                </div>

                <!-- Plan Changes Section -->
                <div v-if="reportData.planChanges && reportData.planChanges.length > 0"
                    class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="bg-yellow-600 text-white px-6 py-3 font-bold text-sm flex justify-between items-center">
                        <span>‚ö†Ô∏è Áõ¥Ëøë„ÅÆ„Éó„É©„É≥Â§âÊõ¥ÔºàÈÅéÂéª6„É∂Êúà‰ª•ÂÜÖÔºâ</span>
                        <span class="text-xs bg-yellow-700 px-2 py-0.5 rounded">{{ reportData.planChanges.length
                            }}‰ª∂</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 text-gray-600">
                                <tr>
                                    <th class="px-4 py-2 text-left border-b">Â∫óËàó</th>
                                    <th class="px-4 py-2 text-left border-b">Â™í‰Ωì</th>
                                    <th class="px-4 py-2 text-center border-b">Â§âÊõ¥Êúà</th>
                                    <th class="px-4 py-2 text-left border-b">Êóß„Éó„É©„É≥</th>
                                    <th class="px-4 py-2 text-left border-b">Êñ∞„Éó„É©„É≥</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="(change, idx) in reportData.planChanges" :key="idx" class="hover:bg-gray-50">
                                    <td class="px-4 py-2 font-bold">{{ change.shop_name }}</td>
                                    <td class="px-4 py-2">{{ change.media_name }}</td>
                                    <td class="px-4 py-2 text-center">{{ Utils.formatYearMonth(change.change_month) }}
                                    </td>
                                    <td class="px-4 py-2 text-gray-500">{{ change.old_plan }}</td>
                                    <td class="px-4 py-2 text-blue-600 font-medium">{{ change.new_plan }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Grand Totals Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="bg-gray-800 text-white px-6 py-3 font-bold text-sm flex justify-between items-center">
                        <span>üìà ÂÖ®Â∫óËàóÂêàË®à</span>
                        <div class="flex items-center gap-4">
                            <span v-if="reportData.hasYoyData"
                                class="text-xs bg-green-600 px-2 py-0.5 rounded">ÂâçÂπ¥ÊØî„Éá„Éº„Çø„ÅÇ„Çä</span>
                            <span class="text-xs bg-gray-700 px-2 py-0.5 rounded">ÊúüÈñì: {{
                                Utils.formatYearMonth(reportData.period.start) }} „Äú {{
                                Utils.formatYearMonth(reportData.period.end) }}</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 text-gray-600">
                                <tr>
                                    <th class="px-4 py-2 text-center border-b">Âπ¥Êúà</th>
                                    <th class="px-4 py-2 border-b">Â£≤‰∏ä</th>
                                    <th v-if="reportData.hasYoyData" class="px-4 py-2 border-b text-xs">ÂâçÂπ¥ÊØî</th>
                                    <th class="px-4 py-2 border-b">UberÂ£≤‰∏ä</th>
                                    <th class="px-4 py-2 border-b">‰∫àÁ¥ÑÊï∞</th>
                                    <th v-if="reportData.hasYoyData" class="px-4 py-2 border-b text-xs">ÂâçÂπ¥ÊØî</th>
                                    <th class="px-4 py-2 border-b">ÂÆ¢Êï∞</th>
                                    <th v-if="reportData.hasYoyData" class="px-4 py-2 border-b text-xs">ÂâçÂπ¥ÊØî</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="(data, ym) in reportData.grandTotals.monthly" :key="ym"
                                    class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-center font-bold text-gray-700">{{
                                        Utils.formatYearMonth(ym) }}</td>
                                    <td class="px-4 py-3 font-bold text-gray-900">{{ formatCurrency(data.sales) }}</td>
                                    <td v-if="reportData.hasYoyData" class="px-4 py-3 text-xs"
                                        :class="getYoYClass(data.sales_yoy)">
                                        {{ data.sales_yoy ? formatPercent(data.sales_yoy, 1) : '-' }}
                                    </td>
                                    <td class="px-4 py-3 text-gray-900">{{ formatCurrency(data.uber_sales || 0) }}</td>
                                    <td class="px-4 py-3">{{ formatNumber(data.reservation_count) }}ÁµÑ</td>
                                    <td v-if="reportData.hasYoyData" class="px-4 py-3 text-xs"
                                        :class="getYoYClass(data.reservation_yoy)">
                                        {{ data.reservation_yoy ? formatPercent(data.reservation_yoy, 1) : '-' }}
                                    </td>
                                    <td class="px-4 py-3">{{ formatNumber(data.guest_count) }}‰∫∫</td>
                                    <td v-if="reportData.hasYoyData" class="px-4 py-3 text-xs"
                                        :class="getYoYClass(data.guest_yoy)">
                                        {{ data.guest_yoy ? formatPercent(data.guest_yoy, 1) : '-' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Shops List (Accordion) -->
                <div class="space-y-4">
                    <div v-for="shop in reportData.shops" :key="shop.shop_code"
                        class="bg-white rounded-lg shadow overflow-hidden transition-all duration-300"
                        :class="{ 'ring-2 ring-blue-400': openShopCode === shop.shop_code }">

                        <!-- Header / Toggle -->
                        <div @click="toggleShop(shop.shop_code)"
                            class="px-6 py-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center select-none border-b border-gray-100 group">
                            <div class="flex items-center gap-3">
                                <div
                                    class="bg-blue-100 text-blue-600 p-2 rounded-full group-hover:bg-blue-200 transition">
                                    üè†</div>
                                <div>
                                    <div class="font-bold text-lg text-gray-800">{{ shop.shop_name }}</div>
                                    <div class="text-xs text-gray-500 flex gap-3 mt-1">
                                        <span class="bg-gray-100 px-2 py-0.5 rounded">Â£≤‰∏ä: {{
                                            formatCurrency(shop.total_sales) }}</span>
                                        <span class="bg-gray-100 px-2 py-0.5 rounded">Uber: {{
                                            formatCurrency(shop.total_uber_sales) }}</span>
                                        <span class="bg-gray-100 px-2 py-0.5 rounded">‰∫àÁ¥Ñ: {{
                                            formatNumber(shop.total_reservation_count) }}ÁµÑ</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-gray-400 transform transition-transform duration-300"
                                :class="{ 'rotate-180': openShopCode === shop.shop_code }">
                                ‚ñº
                            </div>
                        </div>

                        <!-- Â±ïÈñã„Åï„Çå„ÇãÂ∫óËàóË©≥Á¥∞ -->
                        <div v-if="openShopCode === shop.shop_code"
                            class="bg-gray-50 p-0 border-l-4 border-blue-500 animate-slide-down">

                            <!-- Shop Report Body -->
                            <div class="p-6 space-y-8">

                                <!-- AI Shop Comment -->
                                <div v-if="aiEnabled" class="bg-white p-4 rounded shadow border border-purple-100">
                                    <div class="flex justify-between items-center mb-2">
                                        <h4 class="text-xs font-bold text-purple-600 uppercase tracking-wider">AI
                                            Analysis</h4>
                                        <button v-if="!aiShopComments[shop.shop_code]" @click="fetchAiShopComment(shop)"
                                            class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200">
                                            ÂàÜÊûê„ÇíÂÆüË°å
                                        </button>
                                    </div>

                                    <div v-if="aiShopComments[shop.shop_code]">
                                        <div v-if="aiShopComments[shop.shop_code].loading"
                                            class="text-xs text-gray-400 flex items-center gap-2">
                                            <div class="loader w-3 h-3 border-2"></div> ÂàÜÊûê‰∏≠...
                                        </div>
                                        <div v-else-if="aiShopComments[shop.shop_code].error"
                                            class="text-xs text-red-500">
                                            ÂèñÂæó„Ç®„É©„Éº
                                        </div>
                                        <div v-else class="text-sm text-gray-700 whitespace-pre-wrap">
                                            {{ aiShopComments[shop.shop_code].content }}
                                        </div>
                                    </div>
                                </div>

                                <!-- 1. Basic Stats Table -->
                                <div>
                                    <h3
                                        class="text-md font-bold text-gray-700 mb-3 border-b pb-2 flex items-center gap-2">
                                        <span>üìä</span> ÊúàÂà•Êé®Áßª
                                    </h3>
                                    <div class="bg-white rounded shadow-sm overflow-x-auto border border-gray-200">
                                        <table class="w-full text-sm text-right">
                                            <thead class="bg-gray-50 text-gray-600 font-medium">
                                                <tr>
                                                    <th class="px-3 py-2 text-center w-24">Âπ¥Êúà</th>
                                                    <th class="px-3 py-2">Â£≤‰∏ä</th>
                                                    <th v-if="reportData.hasYoyData" class="px-3 py-2 text-xs">ÂâçÂπ¥ÊØî</th>
                                                    <th class="px-3 py-2">UberÂ£≤‰∏ä</th>
                                                    <th class="px-3 py-2">‰∫àÁ¥ÑÊï∞</th>
                                                    <th v-if="reportData.hasYoyData" class="px-3 py-2 text-xs">ÂâçÂπ¥ÊØî</th>
                                                    <th class="px-3 py-2">ÂÆ¢Êï∞</th>
                                                    <th v-if="reportData.hasYoyData" class="px-3 py-2 text-xs">ÂâçÂπ¥ÊØî</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                <tr v-for="m in shop.monthly_summary" :key="m.year_month"
                                                    class="hover:bg-slate-50">
                                                    <td class="px-3 py-2 text-center text-gray-600 font-mono">{{
                                                        m.month_display }}</td>
                                                    <td class="px-3 py-2 font-bold text-gray-800">{{ m.sales }}</td>
                                                    <td v-if="reportData.hasYoyData" class="px-3 py-2 text-xs"
                                                        :class="getYoYClass(m.sales_yoy)">
                                                        {{ m.sales_yoy ? formatPercent(m.sales_yoy, 1) : '-' }}
                                                    </td>
                                                    <td class="px-3 py-2 text-gray-600">{{ formatCurrency(m.uber_sales)
                                                        }}</td>
                                                    <td class="px-3 py-2">{{ Utils.formatNumber(m.reservation_count) }}ÁµÑ
                                                    </td>
                                                    <td v-if="reportData.hasYoyData" class="px-3 py-2 text-xs"
                                                        :class="getYoYClass(m.reservation_yoy)">
                                                        {{ m.reservation_yoy ? formatPercent(m.reservation_yoy, 1) : '-'
                                                        }}
                                                    </td>
                                                    <td class="px-3 py-2">{{ Utils.formatNumber(m.guest_count) }}‰∫∫</td>
                                                    <td v-if="reportData.hasYoyData" class="px-3 py-2 text-xs"
                                                        :class="getYoYClass(m.guest_yoy)">
                                                        {{ m.guest_yoy ? formatPercent(m.guest_yoy, 1) : '-' }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- 2. Booking Channels (Detailed Table + Chart) -->
                                <div>
                                    <h3
                                        class="text-md font-bold text-gray-700 mb-3 border-b pb-2 flex items-center gap-2">
                                        <span>üõ§Ô∏è</span> ‰∫àÁ¥ÑÁµåË∑ØÊßãÊàêÔºà„Éà„É¨„Çø„Éá„Éº„ÇøÔºâ
                                    </h3>

                                    <!-- Chart -->
                                    <div class="bg-white rounded shadow-sm border border-gray-200 p-4 mb-4 h-64">
                                        <canvas :id="'chart-channel-' + shop.shop_code"></canvas>
                                    </div>

                                    <!-- Detailed Table with Monthly Breakdown -->
                                    <div
                                        class="bg-white rounded shadow-sm overflow-x-auto border border-gray-200 custom-scrollbar">
                                        <table class="w-full text-sm whitespace-nowrap text-right">
                                            <thead class="bg-gray-50 text-gray-600 text-xs shadow-sm">
                                                <tr>
                                                    <th
                                                        class="px-3 py-2 text-left bg-gray-100 sticky left-0 border-r z-10 w-36">
                                                        ÁµåË∑Ø</th>
                                                    <th v-for="m in shop.channel_totals_by_month" :key="m.ym"
                                                        class="px-3 py-2 font-medium bg-gray-50 min-w-[80px]">
                                                        {{ Utils.formatMonthShort(m.ym) }}
                                                    </th>
                                                    <th class="px-3 py-2 font-bold bg-gray-100 border-l min-w-[80px]">ÂêàË®à
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                <template v-for="ch in sortedChannelData(shop.channel_data)"
                                                    :key="ch.channel_name">
                                                    <tr class="hover:bg-gray-50 transition-colors"
                                                        :class="{ 'cursor-pointer bg-blue-50/50': ch.channel_name === '„Åù„ÅÆ‰ªñ' }"
                                                        @click="ch.channel_name === '„Åù„ÅÆ‰ªñ' ? toggleOthers(shop.shop_code) : null">
                                                        <td
                                                            class="px-3 py-2 text-left bg-white sticky left-0 border-r z-10 font-bold text-gray-700 flex items-center gap-2 group-hover:bg-gray-50 transition-colors relative">
                                                            <!-- ËÉåÊôØÈÄèÈÅéÈò≤Ê≠¢Áî®„ÅÆÁôΩ„ÅÑ„É¨„Ç§„É§„Éº -->
                                                            <div
                                                                class="absolute inset-0 bg-white -z-10 group-hover:bg-gray-50 border-r border-gray-100">
                                                            </div>

                                                            <span
                                                                class="w-3 h-3 rounded-full flex-shrink-0 relative z-10"
                                                                :style="{ background: getChannelColor(ch.channel_name) }"></span>
                                                            <div class="truncate relative z-10">
                                                                <div class="flex items-center gap-1">
                                                                    <span>{{ ch.channel_name }}</span>
                                                                    <span v-if="ch.channel_name === '„Åù„ÅÆ‰ªñ'"
                                                                        class="text-[10px] text-blue-500 bg-blue-100 px-1.5 rounded-full px-1">
                                                                        {{ othersOpen[shop.shop_code] ? '‚ñ≤ Èñâ„Åò„Çã' : '‚ñº ÂÜÖË®≥'
                                                                        }}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td v-for="md in ch.monthly_data" :key="md.ym"
                                                            class="px-3 py-2">
                                                            <div v-if="md.count > 0">
                                                                <div class="font-bold text-gray-700 leading-tight">
                                                                    {{ formatNumber(md.count) }}<span
                                                                        class="text-[10px] font-normal text-gray-500 ml-0.5">ÁµÑ</span>
                                                                </div>
                                                                <div class="text-[10px] text-gray-400 mt-0.5">{{
                                                                    formatPercent(md.ratio, 1) }}</div>
                                                            </div>
                                                            <div v-else class="text-gray-300 text-center">-</div>
                                                        </td>
                                                        <td class="px-3 py-2 font-bold border-l text-gray-800">
                                                            {{ formatNumber(ch.total_count) }}ÁµÑ
                                                            <span class="block text-xs text-gray-500">{{ ch.total_ratio
                                                                }}</span>
                                                        </td>
                                                    </tr>

                                                    <!-- „Åù„ÅÆ‰ªñÂÜÖË®≥ÔºàÂ±ïÈñãÊôÇÔºâ -->
                                                    <template
                                                        v-if="ch.channel_name === '„Åù„ÅÆ‰ªñ' && othersOpen[shop.shop_code]">
                                                        <tr v-for="otherName in getOthersBreakdown(shop)"
                                                            :key="otherName" class="bg-gray-50/50">
                                                            <td
                                                                class="px-3 py-1.5 text-left bg-gray-50 sticky left-0 border-r z-10 text-xs text-gray-600 pl-8 relative">
                                                                <div
                                                                    class="absolute inset-0 bg-gray-50 -z-10 border-r border-gray-100">
                                                                </div>
                                                                <span class="relative z-10">‚Ä¢ {{ otherName }}</span>
                                                            </td>
                                                            <td v-for="ym in Utils.getMonthsInRange(reportData.period.start, reportData.period.end)"
                                                                :key="ym"
                                                                class="px-3 py-1.5 text-xs text-gray-500 text-right">
                                                                {{ formatOthersCount(shop, ym, otherName) }}
                                                            </td>
                                                            <td
                                                                class="px-3 py-1.5 text-xs font-bold border-l text-gray-600 text-right">
                                                                {{ formatOthersTotal(shop, otherName) }}
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </template>
                                                <!-- Total Row (Excluding Walk-in) -->
                                                <tr class="bg-gray-50 font-bold">
                                                    <td
                                                        class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 text-gray-800">
                                                        ÂêàË®àÔºà„Ç¶„Ç©„Éº„ÇØ„Ç§„É≥Èô§„ÅèÔºâ</td>
                                                    <td v-for="t in shop.channel_totals_by_month" :key="t.ym"
                                                        class="px-3 py-2">
                                                        {{ formatNumber(t.count) }}ÁµÑ
                                                        <span class="block text-xs text-gray-500">100.0%</span>
                                                    </td>
                                                    <td class="px-3 py-2 border-l text-gray-900">
                                                        {{ formatNumber(shop.total_reservation_count) }}ÁµÑ
                                                        <span class="block text-xs text-gray-500">100.0%</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- 3. Media Analysis (Detailed) -->
                                <div v-if="shop.media_analysis.length > 0">
                                    <div v-for="(media, idx) in shop.media_analysis" :key="media.key"
                                        class="mb-8 last:mb-0">
                                        <h3 class="text-md font-bold text-blue-600 mb-2 flex items-center gap-2">
                                            <span>üì¢</span> {{ media.name }}
                                        </h3>

                                        <div v-if="media.has_plan_change"
                                            class="mb-2 text-xs bg-red-50 text-red-600 border border-red-100 p-2 rounded">
                                            ‚ö†Ô∏è „Éó„É©„É≥Â§âÊõ¥„ÅÇ„Çä: {{ media.plan_change_detail }}
                                        </div>

                                        <div
                                            class="bg-white rounded shadow-sm overflow-x-auto border border-gray-200 custom-scrollbar">
                                            <table class="w-full text-sm whitespace-nowrap text-right">
                                                <thead class="bg-gray-50 text-gray-600 text-xs shadow-sm">
                                                    <tr>
                                                        <th
                                                            class="px-3 py-2 text-left bg-gray-100 sticky left-0 border-r z-10 w-32">
                                                            È†ÖÁõÆ</th>
                                                        <th v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 font-medium bg-gray-50 min-w-[70px]">
                                                            {{ Utils.formatMonthShort(m.ym) }}
                                                        </th>
                                                        <th
                                                            class="px-3 py-2 font-bold bg-gray-100 border-l min-w-[80px]">
                                                            ÂêàË®à/Âπ≥Âùá</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-gray-100">
                                                    <!-- Plan Name -->
                                                    <tr>
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-500 text-xs">
                                                            „Éó„É©„É≥Âêç</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-xs text-center text-gray-500 max-w-[100px] truncate"
                                                            :title="m.plan_name">
                                                            {{ m.plan_name }}
                                                        </td>
                                                        <td
                                                            class="px-3 py-2 text-xs text-center text-gray-400 border-l">
                                                            -</td>
                                                    </tr>

                                                    <!-- PV Top -->
                                                    <tr class="bg-blue-50/30">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-700">
                                                            Â∫óËàó„Éà„ÉÉ„ÉóPV</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2">{{ formatNumber(m.pv_top) }}</td>
                                                        <td class="px-3 py-2 font-bold border-l">{{
                                                            formatNumber(media.totals.pv_top) }}</td>
                                                    </tr>

                                                    <!-- PV Total -->
                                                    <tr>
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-600 text-xs">
                                                            ÂêàË®àPV</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-gray-500 text-xs">{{
                                                            formatNumber(m.pv_total) }}</td>
                                                        <td class="px-3 py-2 font-bold border-l text-gray-500 text-xs">
                                                            {{ formatNumber(media.totals.pv_total) }}</td>
                                                    </tr>

                                                    <!-- Reservation (Toreta Total) -->
                                                    <tr class="bg-green-50/30 border-t-2 border-gray-100">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-700">
                                                            ‰∫àÁ¥Ñ‰ª∂Êï∞(hp„ÅØÂèÇËÄÉÂÄ§)</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 font-bold">{{
                                                            formatNumber(m.toreta_reservation) }}ÁµÑ</td>
                                                        <td class="px-3 py-2 font-bold border-l">{{
                                                            formatNumber(media.totals.toreta_reservation) }}ÁµÑ</td>
                                                    </tr>

                                                    <!-- Net Reservation (Media Actual) - Only for Tabelog -->
                                                    <tr v-if="media.key === 'tabelog'">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-medium text-gray-600 text-xs pl-6">
                                                            ÂÜÖ) „Éç„ÉÉ„Éà‰∫àÁ¥ÑÊï∞</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-xs text-gray-500">{{
                                                            formatNumber(m.net_reservation) }}ÁµÑ</td>
                                                        <td class="px-3 py-2 text-xs text-gray-400 border-l">{{
                                                            formatNumber(media.totals.net_reservation) }}ÁµÑ</td>
                                                    </tr>

                                                    <!-- Note Reservation (Calculation) - Only for Tabelog -->
                                                    <tr v-if="media.key === 'tabelog'">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-medium text-gray-600 text-xs pl-6">
                                                            ÂÜÖ) „Éé„Éº„ÉàÁµÑÊï∞</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-xs text-gray-500">{{
                                                            formatNumber(m.note_reservation) }}ÁµÑ</td>
                                                        <td class="px-3 py-2 text-xs text-gray-400 border-l">{{
                                                            formatNumber(media.totals.note_reservation) }}ÁµÑ</td>
                                                    </tr>

                                                    <!-- Guest (Toreta Total) -->
                                                    <tr class="bg-blue-50/10 border-t border-gray-100">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-700">
                                                            ‰∫àÁ¥Ñ‰∫∫Êï∞</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2">{{ formatNumber(m.toreta_guest) }}‰∫∫</td>
                                                        <td class="px-3 py-2 font-bold border-l">{{
                                                            formatNumber(media.totals.toreta_guest) }}‰∫∫</td>
                                                    </tr>

                                                    <!-- Net Guest (Media Actual) - Only for Tabelog -->
                                                    <tr v-if="media.key === 'tabelog'">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-medium text-gray-600 text-xs pl-6">
                                                            ÂÜÖ) „Éç„ÉÉ„Éà‰∫àÁ¥Ñ‰∫∫Êï∞</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-xs text-gray-500">{{
                                                            formatNumber(m.net_guest) }}‰∫∫</td>
                                                        <td class="px-3 py-2 text-xs text-gray-400 border-l">{{
                                                            formatNumber(media.totals.net_guest) }}‰∫∫</td>
                                                    </tr>

                                                    <!-- Note Guest (Calculation) - Only for Tabelog -->
                                                    <tr v-if="media.key === 'tabelog'">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-medium text-gray-600 text-xs pl-6">
                                                            ÂÜÖ) „Éé„Éº„Éà‰∫∫Êï∞</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-xs text-gray-500">{{
                                                            formatNumber(m.note_guest) }}‰∫∫</td>
                                                        <td class="px-3 py-2 text-xs text-gray-400 border-l">{{
                                                            formatNumber(media.totals.note_guest) }}‰∫∫</td>
                                                    </tr>

                                                    <!-- CVR -->
                                                    <tr class="bg-yellow-50/30 border-t-2 border-gray-100">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-700">
                                                            CVR</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2">{{ m.cvr ? Utils.formatPercent(m.cvr, 2) :
                                                            '-' }}</td>
                                                        <td class="px-3 py-2 font-bold border-l">{{ media.totals.cvr ?
                                                            Utils.formatPercent(media.totals.cvr, 2) : '-' }}</td>
                                                    </tr>

                                                    <!-- Cost -->
                                                    <tr class="bg-red-50/30 border-t-2 border-gray-100">
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-700">
                                                            Ë≤ªÁî®ÂêàË®à</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2">{{ formatCurrency(m.cost) }}</td>
                                                        <td class="px-3 py-2 font-bold border-l">{{
                                                            formatCurrency(media.totals.cost) }}</td>
                                                    </tr>

                                                    <!-- Revenue -->
                                                    <tr>
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-600 text-xs">
                                                            ÊÉ≥ÂÆöÂ£≤‰∏ä</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-gray-500 text-xs">{{
                                                            formatCurrency(m.revenue) }}</td>
                                                        <td class="px-3 py-2 font-bold border-l text-gray-500 text-xs">
                                                            {{ formatCurrency(media.totals.revenue) }}</td>
                                                    </tr>

                                                    <!-- Profit -->
                                                    <tr>
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-700">
                                                            Âà©ÁõäÈ°ç</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 font-bold"
                                                            :class="getProfitClass(m.profit)">{{
                                                            formatCurrency(m.profit) }}</td>
                                                        <td class="px-3 py-2 font-bold border-l"
                                                            :class="getProfitClass(media.totals.profit)">{{
                                                            formatCurrency(media.totals.profit) }}</td>
                                                    </tr>

                                                    <!-- Cost Per Guest -->
                                                    <tr>
                                                        <td
                                                            class="px-3 py-2 text-left bg-gray-50 sticky left-0 border-r z-10 font-bold text-gray-600 text-xs">
                                                            ÈÄÅÂÆ¢„Ç≥„Çπ„Éà/‰∫∫</td>
                                                        <td v-for="m in media.monthly_values" :key="m.ym"
                                                            class="px-3 py-2 text-gray-500 text-xs">{{ m.cost_per_guest
                                                            ? formatCurrency(m.cost_per_guest) : '-' }}</td>
                                                        <td class="px-3 py-2 font-bold border-l text-gray-500 text-xs">
                                                            {{ media.totals.cost_per_guest ?
                                                            formatCurrency(media.totals.cost_per_guest) : '-' }}</td>
                                                    </tr>

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- 4. Ad Cost Table -->
                                <div v-if="shop.ad_cost_table" class="mt-8 border-t border-gray-200 pt-6">
                                    <h3 class="text-md font-bold text-gray-700 mb-3 flex items-center gap-2">
                                        <span>üí∞</span> Â∫ÉÂëäË≤ª„ÉªÈÅãÁî®Ë≤ª
                                    </h3>
                                    <div
                                        class="bg-white rounded shadow-sm overflow-x-auto border border-gray-200 custom-scrollbar">
                                        <table class="w-full text-sm whitespace-nowrap text-right">
                                            <thead class="bg-gray-50 text-gray-600 text-xs shadow-sm">
                                                <tr>
                                                    <th
                                                        class="px-3 py-2 text-left bg-gray-100 sticky left-0 border-r z-10 w-32">
                                                        Â™í‰Ωì</th>
                                                    <th class="px-3 py-2 text-left bg-gray-50 w-32">„Éó„É©„É≥</th>
                                                    <th v-for="ym in Utils.getMonthsInRange(reportData.period.start, reportData.period.end)"
                                                        :key="ym" class="px-3 py-2 font-medium bg-gray-50 min-w-[70px]">
                                                        {{ Utils.formatMonthShort(ym) }}
                                                    </th>
                                                    <th class="px-3 py-2 font-bold bg-gray-100 border-l min-w-[80px]">ÂêàË®à
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                <tr v-for="row in shop.ad_cost_table.rows" :key="row.media_name"
                                                    class="hover:bg-gray-50">
                                                    <td
                                                        class="px-3 py-2 text-left bg-white sticky left-0 border-r z-10 font-bold text-gray-700">
                                                        {{ row.media_name }}
                                                    </td>
                                                    <td class="px-3 py-2 text-left text-xs text-gray-500">
                                                        {{ row.plan_name }}
                                                    </td>
                                                    <td v-for="ym in Utils.getMonthsInRange(reportData.period.start, reportData.period.end)"
                                                        :key="ym" class="px-3 py-2">
                                                        {{ formatCurrency(row.costs[ym]) }}
                                                    </td>
                                                    <td class="px-3 py-2 font-bold border-l text-gray-800">
                                                        {{ formatCurrency(row.total_cost) }}
                                                    </td>
                                                </tr>
                                                <!-- Total Row -->
                                                <tr class="bg-gray-50 font-bold">
                                                    <td
                                                        class="px-3 py-2 text-left sticky left-0 border-r z-10 text-gray-800">
                                                        ÂêàË®à</td>
                                                    <td class="px-3 py-2">-</td>
                                                    <td v-for="ym in Utils.getMonthsInRange(reportData.period.start, reportData.period.end)"
                                                        :key="ym" class="px-3 py-2">
                                                        {{ formatCurrency(shop.ad_cost_table.monthly_totals[ym]) }}
                                                    </td>
                                                    <td class="px-3 py-2 border-l text-gray-900">
                                                        {{ formatCurrency(shop.ad_cost_table.grand_total) }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Glassmorphism Shop Detail Bar (Sticky Footer) -->
        <transition name="slide-up">
            <div v-if="openShopCode"
                class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-40 w-[94%] max-w-2xl px-6 py-4 rounded-2xl shadow-2xl glass-container flex justify-between items-center border border-white/20 backdrop-blur-md">

                <div class="flex items-center gap-4">
                    <div class="bg-blue-500/20 p-2 rounded-xl text-blue-100 hidden sm:block">
                        üè†
                    </div>
                    <div>
                        <p class="text-[10px] text-blue-200 font-bold uppercase tracking-[0.1em] mb-0.5">Analyzing
                            Report</p>
                        <h3 class="text-lg font-bold text-white leading-tight truncate max-w-[200px] sm:max-w-none">
                            {{ getShopName(openShopCode) }}
                        </h3>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button @click="closeShop"
                        class="bg-white/10 hover:bg-white/20 text-white px-5 py-2.5 rounded-xl transition font-bold text-sm border border-white/10">
                        ‚úï Èñâ„Åò„Çã
                    </button>
                </div>
            </div>
        </transition>

    </div>

    <style>
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        .animate-slide-down {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <!-- Scripts -->
    <?!= include('scripts'); ?>
</body>

</html>