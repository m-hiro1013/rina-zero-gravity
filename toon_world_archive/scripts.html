<script>
// --- chart-renderer.js ---
// ============================================
// Chart Renderer Module
// ============================================

const ChartRenderer = {
    instances: {}, // Chart instances storage

    /**
     * Destroy chart instance if exists
     */
    destroy(id) {
        if (this.instances[id]) {
            this.instances[id].destroy();
            delete this.instances[id];
        }
    },

    /**
     * Render Charts for a specific shop
     */
    renderShopCharts(shop, channelColors) {
        const shopCode = shop.shop_code;

        // 1. Channel Distribution (Stacked Bar Chart)
        this.renderChannelChart(shop, channelColors);
    },

    /**
     * Render Channel Distribution Stacked Bar Chart
     * Êóß„Éê„Éº„Ç∏„Éß„É≥‰∫íÊèõ: ÊúàÂà•„ÅÆ100%Á©ç„Åø‰∏ä„ÅíÊ£í„Ç∞„É©„Éï
     */
    renderChannelChart(shop, channelColors) {
        const canvasId = `chart-channel-${shop.shop_code}`;
        const canvas = document.getElementById(canvasId);

        if (!canvas) {
            console.warn(`Canvas element not found: ${canvasId}`);
            return;
        }

        this.destroy(canvasId);

        // ÊúàÂà•„É©„Éô„É´
        const labels = shop.channel_totals_by_month.map(t => Utils.formatMonthShort(t.ym));

        // ÂêÑÁµåË∑Ø„ÅÆ„Éá„Éº„Çø„Çª„ÉÉ„ÉàÊßãÁØâ
        const datasets = shop.channel_data
            .filter(ch => ch.total_count > 0)
            .map(ch => {
                const data = ch.monthly_data.map(md => md.ratio); // ÊßãÊàêÊØîÔºà%Ôºâ

                return {
                    label: ch.channel_name,
                    data: data,
                    backgroundColor: channelColors[ch.channel_name] || '#9E9E9E'
                };
            });

        const ctx = canvas.getContext('2d');
        this.instances[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: {
                        stacked: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: { size: 10 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + '%'
                        }
                    }
                }
            }
        });
    }
};


// --- utils.js ---
// ============================================
// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
// ============================================

const Utils = {
    getMonthsInRange(start, end) {
        const months = [];
        let current = start;
        while (current <= end) {
            months.push(current);
            const year = Math.floor(current / 100);
            const month = current % 100;
            if (month === 12) {
                current = (year + 1) * 100 + 1;
            } else {
                current = year * 100 + (month + 1);
            }
        }
        return months;
    },

    formatYearMonth(ym) {
        const year = Math.floor(ym / 100);
        const month = ym % 100;
        return `${year}Âπ¥${month}Êúà`;
    },

    formatMonthShort(ym) {
        const month = ym % 100;
        return `${month}Êúà`;
    },

    formatNumber(num) {
        if (num === null || num === undefined) return '-';
        return num.toLocaleString();
    },

    formatCurrency(num) {
        if (num === null || num === undefined) return '-';
        return '¬•' + num.toLocaleString();
    },

    formatPercent(num, decimals = 1) {
        if (num === null || num === undefined) return '-';
        return num.toFixed(decimals) + '%';
    }
};

// ============================================
// Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
// ============================================

const Calculations = {
    calcReservationExcludingWalkinArray(monthlyToretaArray) {
        if (!monthlyToretaArray || monthlyToretaArray.length === 0) {
            return { reservation_count: 0, guest_count: 0 };
        }
        const total = monthlyToretaArray.find(d => d.media === 'ÂêàË®à') || { reservation_count: 0, guest_count: 0 };
        const walkin = monthlyToretaArray.find(d => d.media === '„Ç¶„Ç©„Éº„ÇØ„Ç§„É≥') || { reservation_count: 0, guest_count: 0 };

        return {
            reservation_count: (total.reservation_count || 0) - (walkin.reservation_count || 0),
            guest_count: (total.guest_count || 0) - (walkin.guest_count || 0)
        };
    },

    calcYoY(current, previous) {
        if (!previous || previous === 0) return null;
        return (current / previous) * 100;
    },

    getYoYClass(yoyValue) {
        if (yoyValue === null) return 'yoy-neutral';
        return yoyValue >= 100 ? 'yoy-positive' : 'yoy-negative';
    },

    calcPV(mediaMonthData) {
        if (!mediaMonthData) return { top: 0, total: 0 };
        return {
            top: (mediaMonthData.pv_sp_top || 0) + (mediaMonthData.pv_pc_top || 0),
            total: (mediaMonthData.pv_sp_total || 0) + (mediaMonthData.pv_pc_total || 0)
        };
    },

    calcCVR(reservationCount, pvTop) {
        if (!pvTop || pvTop === 0) return null;
        return (reservationCount / pvTop) * 100;
    },

    calcTotalCost(mediaMonthData) {
        if (!mediaMonthData) return 0;
        const baseCost = mediaMonthData.base_cost || 0;
        const unitLunch = mediaMonthData.unit_cost_lunch || 0;
        const unitDinner = mediaMonthData.unit_cost_dinner || 0;
        const guestLunch = mediaMonthData.guest_count_lunch || 0;
        const guestDinner = mediaMonthData.guest_count_dinner || 0;
        const guestTotal = mediaMonthData.guest_count_total || 0;

        if (guestLunch > 0 || guestDinner > 0) {
            return baseCost + (unitLunch * guestLunch) + (unitDinner * guestDinner);
        }
        return baseCost + (unitDinner * guestTotal);
    },

    calcEstimatedRevenue(mediaMonthData, avgPriceLunch, avgPriceDinner) {
        if (!mediaMonthData) return 0;
        const guestLunch = mediaMonthData.guest_count_lunch || 0;
        const guestDinner = mediaMonthData.guest_count_dinner || 0;
        const guestTotal = mediaMonthData.guest_count_total || 0;

        if (guestLunch > 0 || guestDinner > 0) {
            return (guestLunch * avgPriceLunch) + (guestDinner * avgPriceDinner);
        }
        return guestTotal * avgPriceDinner;
    },

    getProfitClass(profit) {
        return profit >= 0 ? 'profit-positive' : 'profit-negative';
    },

    calcCostPerGuest(totalCost, guestCount) {
        if (!guestCount || guestCount === 0) return null;
        return Math.floor(totalCost / guestCount);
    },

    // Âõ∫ÂÆöË°®Á§∫„Åô„Çã‰∏ªË¶ÅÂ™í‰Ωì„É™„Çπ„ÉàÔºà‰∏ªË¶Å‰ª•Â§ñ„ÅØ„Äå„Åù„ÅÆ‰ªñ„Äç„Å´Áµ±ÂêàÔºâ
    FIXED_CHANNELS: [
        'ÈõªË©±',
        '„Éà„É¨„Çø‰∫àÁ¥ÑÁï™',
        'È£ü„Åπ„É≠„Ç∞',
        '„Éõ„ÉÉ„Éà„Éö„ÉÉ„Éë„Éº',
        '„Åê„Çã„Å™„Å≥',
        'Retty',
        'Google„Åß‰∫àÁ¥Ñ'
    ],

    getTopChannels(shop, months) {
        const channelTotals = {};
        const allChannels = new Set();

        // ÊúüÈñìÂÜÖ„ÅÆÂÖ®Êúà„ÅÆ„Éà„É¨„Çø„Éá„Éº„Çø„Åã„ÇâÁµåË∑ØÂà•„ÅÆ‰∫àÁ¥ÑÊï∞„ÇíÈõÜË®à
        months.forEach(ym => {
            const monthlyToreta = (shop.toreta_data || []).filter(d => d.year_month === ym);
            if (!monthlyToreta) return;

            monthlyToreta.forEach(d => {
                const channel = d.media;
                // „ÄåÂêàË®à„Äç„Å®„Äå„Ç¶„Ç©„Éº„ÇØ„Ç§„É≥„Äç„ÅØÈô§Â§ñ
                if (channel === 'ÂêàË®à' || channel === '„Ç¶„Ç©„Éº„ÇØ„Ç§„É≥') return;

                allChannels.add(channel);
                const count = d.reservation_count || 0;

                if (!channelTotals[channel]) {
                    channelTotals[channel] = 0;
                }
                channelTotals[channel] += count;
            });
        });

        const fixed = this.FIXED_CHANNELS;
        const others = Array.from(allChannels).filter(ch => !this.FIXED_CHANNELS.includes(ch));

        return { fixed, others };
    },

    /**
     * ÂâçÂπ¥„Éá„Éº„Çø„ÅÆÊúâÁÑ°„Çí„ÉÅ„Çß„ÉÉ„ÇØ
     */
    checkYoyDataAvailability(data, periodStart, periodEnd) {
        const months = Utils.getMonthsInRange(periodStart, periodEnd);
        const yoyMonths = months.map(m => m - 100);

        for (const shop of data.shops) {
            const availableMonths = (shop.monthly_data || []).map(d => d.year_month);
            const hasAnyYoyData = yoyMonths.some(ym => availableMonths.includes(ym));
            if (hasAnyYoyData) {
                return true;
            }
        }
        return false;
    },

    /**
     * ÊåáÂÆöÊúüÈñìÂÜÖ„ÅÆ„Éó„É©„É≥Â§âÊõ¥‰∏ÄË¶ß„ÇíÊ§úÂá∫Ôºà„Çµ„Éû„É™„ÉºÁî®Ôºâ
     */
    detectPlanChanges(data, months) {
        const changes = [];
        const focusMonth = months[months.length - 1];

        // ÈÅéÂéª6„É∂Êúà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßãÁÇπ„ÇíË®àÁÆó
        let checkStart = focusMonth;
        for (let i = 0; i < 6; i++) {
            const year = Math.floor(checkStart / 100);
            const month = checkStart % 100;
            if (month === 1) {
                checkStart = (year - 1) * 100 + 12;
            } else {
                checkStart = year * 100 + (month - 1);
            }
        }

        const mediaNames = {
            'tabelog': 'È£ü„Åπ„É≠„Ç∞',
            'hotpepper': '„Éõ„ÉÉ„Éà„Éö„ÉÉ„Éë„Éº',
            'gurunavi': '„Åê„Çã„Å™„Å≥',
            'line': 'LINE',
            'conetto': '„Ç≥„Éç„ÉÉ„Éà'
        };

        data.shops.forEach(shop => {
            Object.keys(shop.media_data).forEach(mediaKey => {
                const mediaRows = shop.media_data[mediaKey] || [];
                const sortedRows = [...mediaRows].sort((a, b) => a.year_month - b.year_month);

                for (let i = 1; i < sortedRows.length; i++) {
                    const prevRow = sortedRows[i - 1];
                    const currRow = sortedRows[i];

                    if (currRow.year_month < checkStart || currRow.year_month > focusMonth) continue;

                    const prevPlan = prevRow.plan_name;
                    const currPlan = currRow.plan_name;

                    if (prevPlan && currPlan && prevPlan !== currPlan) {
                        changes.push({
                            shop_name: shop.shop_name,
                            shop_code: shop.shop_code,
                            media_key: mediaKey,
                            media_name: mediaNames[mediaKey] || mediaKey,
                            change_month: currRow.year_month,
                            old_plan: prevPlan,
                            new_plan: currPlan
                        });
                    }
                }
            });
        });

        return changes;
    }
};


// --- parser.js ---
class ToonParser {
    constructor() { }

    parse(content) {
        const lines = content.split('\n');
        const result = {
            export_info: {
                exported_at: null,
                period: { start: null, end: null },
                shop_count: 0,
                year_month_count: 0
            },
            shops: []
        };

        let i = 0;
        const totalLines = lines.length;

        function getIndentLevel(line) {
            const match = line.match(/^(\s*)/);
            return match ? match[1].length : 0;
        }

        function parseKeyValue(line) {
            const trimmed = line.trim();
            const colonIndex = trimmed.indexOf(':');
            if (colonIndex === -1) return { key: trimmed, value: null };
            const key = trimmed.substring(0, colonIndex).trim();
            const value = trimmed.substring(colonIndex + 1).trim();
            return { key, value: value || null };
        }

        function parseTableHeader(key) {
            const match = key.match(/^(.+?)\[(\d+)\]\{(.+)\}$/);
            if (!match) return null;
            return {
                name: match[1],
                count: parseInt(match[2]),
                columns: match[3].split(',')
            };
        }

        function parseValue(val) {
            if (val === null || val === '' || val === 'null') return null;
            if (val === 'true') return true;
            if (val === 'false') return false;
            const num = Number(val);
            if (!isNaN(num) && val !== '') return num;
            return val;
        }

        function parseTableRows(startIndex, count, columns, baseIndent) {
            const rows = [];
            let idx = startIndex;

            while (idx < totalLines && rows.length < count) {
                const line = lines[idx];
                if (!line.trim()) {
                    idx++;
                    continue;
                }

                const currentIndent = getIndentLevel(line);
                if (currentIndent <= baseIndent && line.trim()) {
                    break;
                }

                const values = line.trim().split(',');
                if (values.length === columns.length) {
                    const row = {};
                    columns.forEach((col, colIdx) => {
                        row[col] = parseValue(values[colIdx]);
                    });
                    rows.push(row);
                }
                idx++;
            }

            return { rows, nextIndex: idx };
        }

        // export_info „Éë„Éº„Çπ
        while (i < totalLines) {
            const line = lines[i];
            if (line.trim().startsWith('export_info:')) {
                i++;
                while (i < totalLines) {
                    const subLine = lines[i];
                    if (!subLine.trim() || getIndentLevel(subLine) === 0) break;

                    const { key, value } = parseKeyValue(subLine);

                    if (key === 'exported_at') {
                        result.export_info.exported_at = value;
                    } else if (key === 'period') {
                        i++;
                        while (i < totalLines && getIndentLevel(lines[i]) > 2) {
                            const periodLine = parseKeyValue(lines[i]);
                            if (periodLine.key === 'start') {
                                result.export_info.period.start = parseInt(periodLine.value);
                            } else if (periodLine.key === 'end') {
                                result.export_info.period.end = parseInt(periodLine.value);
                            }
                            i++;
                        }
                        continue;
                    } else if (key === 'shop_count') {
                        result.export_info.shop_count = parseInt(value);
                    } else if (key === 'year_month_count') {
                        result.export_info.year_month_count = parseInt(value);
                    }
                    i++;
                }
                break;
            }
            i++;
        }

        // shops „Éë„Éº„Çπ
        while (i < totalLines) {
            const line = lines[i];
            if (line.trim().match(/^shops\[\d+\]:/)) {
                i++;
                break;
            }
            i++;
        }

        let currentShop = null;

        while (i < totalLines) {
            const line = lines[i];
            const trimmed = line.trim();

            if (!trimmed) {
                i++;
                continue;
            }

            const indent = getIndentLevel(line);

            if (trimmed.startsWith('- shop_code:')) {
                if (currentShop) {
                    result.shops.push(currentShop);
                }
                currentShop = {
                    shop_code: parseValue(trimmed.split(':')[1].trim()),
                    shop_name: '',
                    avg_price_lunch: 0,
                    avg_price_dinner: 0,
                    monthly_data: [],
                    toreta_data: [],
                    media_data: {},
                    ad_cost_data: [],
                    uber_data: []
                };
                i++;
                continue;
            }

            if (!currentShop) {
                i++;
                continue;
            }

            const { key, value } = parseKeyValue(line);

            // ÂçòÁ¥î„Å™„Ç≠„Éº„Éª„Éê„É™„É•„ÉºÔºàshop_name Á≠âÔºâ
            if (['shop_name', 'avg_price_lunch', 'avg_price_dinner'].includes(key)) {
                currentShop[key] = parseValue(value);
                i++;
                continue;
            }

            // --- „Éë„Çø„Éº„É≥A: „ÉÜ„Éº„Éñ„É´„Éò„ÉÉ„ÉÄ„ÉºÊ§úÂá∫ (xxx[N]{cols}:) ---
            const tableInfo = parseTableHeader(key);
            if (tableInfo) {
                i++;
                const { rows, nextIndex } = parseTableRows(i, tableInfo.count, tableInfo.columns, indent);
                currentShop[tableInfo.name] = rows;
                i = nextIndex;
                continue;
            }

            // --- „Éë„Çø„Éº„É≥B: „Ç∞„É´„Éº„Éó„Ç≠„Éº (media_data: „ÅÆ„Çà„ÅÜ„Å™ÂÄ§„Å™„Åó„Ç≠„Éº) ---
            if (value === null && i + 1 < totalLines) {
                const nextIndent = getIndentLevel(lines[i + 1]);
                if (nextIndent > indent) {
                    // „Ç∞„É´„Éº„Éó„ÅÆÂ≠êË¶ÅÁ¥†„Çí„Éë„Éº„Çπ
                    currentShop[key] = {};
                    i++;
                    while (i < totalLines) {
                        const childLine = lines[i];
                        if (!childLine || !childLine.trim()) { i++; continue; }

                        const childIndent = getIndentLevel(childLine);
                        if (childIndent <= indent) break; // „Ç§„É≥„Éá„É≥„Éà„ÅåÊàª„Å£„Åü„ÇâÁµÇ‰∫Ü

                        const childKV = parseKeyValue(childLine);
                        const childTableInfo = parseTableHeader(childKV.key);

                        // Â≠êË¶ÅÁ¥†ÂÜÖ„ÅÆ„ÉÜ„Éº„Éñ„É´„Çí„Éë„Éº„Çπ
                        if (childTableInfo) {
                            i++;
                            const { rows, nextIndex } = parseTableRows(i, childTableInfo.count, childTableInfo.columns, childIndent);
                            currentShop[key][childTableInfo.name] = rows;
                            i = nextIndex;
                            continue;
                        }

                        // „ÉÜ„Éº„Éñ„É´„Åß„Å™„Åë„Çå„Å∞Âçò„Å™„Çã„Éç„Çπ„Éà„Åó„ÅüÂÄ§„Å®„Åó„Å¶‰øùÊåÅÔºàÂøÖË¶Å„Å™„ÇâÂÜçÂ∏∞ÁöÑ„Å´Êã°ÂºµÂèØËÉΩÔºâ
                        if (childKV.value !== null) {
                            currentShop[key][childKV.key] = parseValue(childKV.value);
                        }

                        i++;
                    }
                    continue;
                }
            }

            i++;
        }

        if (currentShop) {
            result.shops.push(currentShop);
        }

        return result;
    }
}


// --- data-builder.js ---
// ============================================
// Data Builder Module
// ============================================

const DataBuilder = {
    /**
     * ParseÊ∏à„Åø„Éá„Éº„Çø„Åã„Çâ„É¨„Éù„Éº„ÉàË°®Á§∫Áî®„Éá„Éº„Çø„ÇíÊßãÁØâ„Åô„Çã
     * (ÂÖÉ„ÅÆ scripts.html „ÅÆ buildReportDataForAi Áõ∏ÂΩì)
     */
    build(parsedData, periodStart, periodEnd, selectedShops) {
        const months = Utils.getMonthsInRange(periodStart, periodEnd);

        // Filter Shop Logic
        let shops = parsedData.shops;
        if (selectedShops && selectedShops.length > 0) {
            shops = shops.filter(shop => selectedShops.includes(shop.shop_code));
        }

        // ÂâçÂπ¥ÊØî„Éá„Éº„Çø„ÅÆÊúâÁÑ°„ÇíÂà§ÂÆö
        const hasYoyData = Calculations.checkYoyDataAvailability(parsedData, periodStart, periodEnd);

        // ÂÖ®‰ΩìÈõÜË®à„ÅÆË®àÁÆóÔºàÂâçÂπ¥ÊØîËæº„ÅøÔºâ
        const grandTotals = this.calcGrandTotals(shops, months, hasYoyData);

        // „Éó„É©„É≥Â§âÊõ¥‰∏ÄË¶ßÔºà„Çµ„Éû„É™„ÉºÁî®Ôºâ
        const planChanges = Calculations.detectPlanChanges(parsedData, months);

        // „É¨„Éù„Éº„ÉàÁî®„Éá„Éº„ÇøÊßãÈÄ†„ÅÆÊßãÁØâ
        const reportData = {
            period: {
                start: periodStart,
                end: periodEnd
            },
            hasYoyData: hasYoyData,
            planChanges: planChanges,
            shops: [],
            grandTotals: grandTotals
        };

        shops.forEach(shop => {
            // ÈÖçÂàó„Éá„Éº„Çø„ÇíÊ§úÁ¥¢„Åó„ÇÑ„Åô„ÅÑ„Çà„ÅÜ„Å´ Map „Å´Â§âÊèõ
            const monthlyMap = new Map((shop.monthly_data || []).map(d => [d.year_month, d]));
            const toretaMap = new Map((shop.toreta_data || []).map(d => [`${d.year_month}|${d.media}`, d]));
            const adCostMap = new Map((shop.ad_cost_data || []).map(d => [`${d.year_month}|${d.media}`, d]));
            const uberMap = new Map((shop.uber_data || []).map(d => {
                if (d.hourly_orders && typeof d.hourly_orders === 'string') {
                    try { d.hourly_orders = JSON.parse(d.hourly_orders); } catch (e) { d.hourly_orders = {}; }
                }
                return [d.year_month, d];
            }));

            const shopData = {
                shop_code: shop.shop_code,
                shop_name: shop.shop_name,
                avg_price_lunch: shop.avg_price_lunch,
                avg_price_dinner: shop.avg_price_dinner,
                total_sales: 0,
                total_reservation_count: 0,
                total_guest_count: 0,
                total_uber_sales: 0, // üÜï ËøΩÂä†
                monthly_summary: [],
                channel_data: [],
                media_analysis: [],
                ad_cost_table: null,
                raw_ad_cost_data: shop.ad_cost_data,
                raw_monthly_data: shop.monthly_data,
                raw_toreta_data: shop.toreta_data,
                raw_uber_data: shop.uber_data // üÜï ËøΩÂä†
            };

            // ÊúàÂà•„Çµ„Éû„É™„ÉºÔºàÂâçÂπ¥ÊØîËæº„ÅøÔºâ
            months.forEach(ym => {
                const sales = monthlyMap.get(ym)?.sales_amount || 0;
                const monthlyToreta = (shop.toreta_data || []).filter(d => d.year_month === ym);
                const reservation = Calculations.calcReservationExcludingWalkinArray(monthlyToreta);
                const uber = uberMap.get(ym) || {};

                shopData.total_sales += sales;
                shopData.total_reservation_count += reservation.reservation_count;
                shopData.total_guest_count += reservation.guest_count;
                shopData.total_uber_sales += (uber.sales_amount || 0);

                // ÂâçÂπ¥ÊØîË®àÁÆó
                let salesYoy = null;
                let reservationYoy = null;
                let guestYoy = null;
                if (hasYoyData) {
                    const yoyMonth = ym - 100;
                    const yoySales = monthlyMap.get(yoyMonth)?.sales_amount || 0;
                    const yoyToreta = (shop.toreta_data || []).filter(d => d.year_month === yoyMonth);
                    const yoyRes = Calculations.calcReservationExcludingWalkinArray(yoyToreta);

                    salesYoy = Calculations.calcYoY(sales, yoySales);
                    reservationYoy = Calculations.calcYoY(reservation.reservation_count, yoyRes.reservation_count);
                    guestYoy = Calculations.calcYoY(reservation.guest_count, yoyRes.guest_count);
                }

                shopData.monthly_summary.push({
                    year_month: ym,
                    month_display: Utils.formatMonthShort(ym),
                    sales: Utils.formatCurrency(sales),
                    sales_raw: sales,
                    reservation_count: reservation.reservation_count,
                    guest_count: reservation.guest_count,
                    uber_sales: uber.sales_amount || 0, // üÜï ËøΩÂä†
                    sales_yoy: salesYoy,
                    reservation_yoy: reservationYoy,
                    guest_yoy: guestYoy
                });
            });

            // ÁµåË∑Ø„Éá„Éº„Çø (Calculations.getTopChannels ‰ΩøÁî®)
            const { fixed, others } = Calculations.getTopChannels(shop, months);
            const allChannels = [...fixed];
            if (others.length > 0) allChannels.push('„Åù„ÅÆ‰ªñ');

            allChannels.forEach(channel => {
                const isOthers = channel === '„Åù„ÅÆ‰ªñ';
                let channelTotal = 0;
                const monthlyData = [];

                months.forEach(ym => {
                    const monthlyToreta = (shop.toreta_data || []).filter(d => d.year_month === ym);
                    const totalReservation = Calculations.calcReservationExcludingWalkinArray(monthlyToreta);

                    let count = 0;
                    if (isOthers) {
                        others.forEach(ch => {
                            const d = monthlyToreta.find(t => t.media === ch);
                            count += d ? d.reservation_count : 0;
                        });
                    } else {
                        const d = monthlyToreta.find(t => t.media === channel);
                        count = d ? d.reservation_count : 0;
                    }
                    channelTotal += count;

                    const ratio = totalReservation.reservation_count > 0
                        ? (count / totalReservation.reservation_count * 100)
                        : 0;

                    monthlyData.push({
                        ym: ym,
                        count: count,
                        ratio: ratio
                    });
                });

                const ratio = shopData.total_reservation_count > 0
                    ? (channelTotal / shopData.total_reservation_count * 100).toFixed(1) + '%'
                    : '0.0%';

                shopData.channel_data.push({
                    channel_name: channel,
                    total_count: channelTotal,
                    total_ratio: ratio,
                    monthly_data: monthlyData,
                    breakdown: isOthers ? others.sort() : []
                });
            });

            // ÁµåË∑Ø„ÉÜ„Éº„Éñ„É´„ÅÆ„ÄåÂêàË®àÔºà„Ç¶„Ç©„Éº„ÇØ„Ç§„É≥Èô§„ÅèÔºâ„ÄçË°åÁî®„Éá„Éº„Çø
            shopData.channel_totals_by_month = months.map(ym => {
                const monthlyToreta = (shop.toreta_data || []).filter(d => d.year_month === ym);
                const totalRes = Calculations.calcReservationExcludingWalkinArray(monthlyToreta);
                return {
                    ym: ym,
                    count: totalRes.reservation_count
                };
            });

            // Â™í‰ΩìÂà•ÂàÜÊûê
            const mediaKeys = Object.keys(shop.media_data).sort((a, b) => {
                const order = ['tabelog', 'hotpepper', 'gurunavi', 'line'];
                const idxA = order.indexOf(a);
                const idxB = order.indexOf(b);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.localeCompare(b);
            });

            mediaKeys.forEach(mediaKey => {
                const mediaRows = shop.media_data[mediaKey] || [];
                const mediaMap = new Map(mediaRows.map(r => [r.year_month, r]));
                const planChange = this.detectMediaPlanChangeArray(mediaRows, months);
                const mediaName = this.getMediaName(mediaKey);

                let totalPvTop = 0;
                let totalPvTotal = 0;
                let totalReservation = 0;
                let totalGuest = 0;
                let totalCost = 0;
                let totalRevenue = 0;
                let cvrSum = 0;
                let cvrCount = 0;
                let costPerGuestSum = 0;
                let costPerGuestCount = 0;

                let totalNoteReservation = 0;
                let totalNoteGuest = 0;

                const monthlyValues = months.map(ym => {
                    const m = mediaMap.get(ym) || {};
                    const toretaName = this.getMediaName(mediaKey);
                    const toretaData = toretaMap.get(`${ym}|${toretaName}`) || {};

                    const pv = Calculations.calcPV(m);
                    totalPvTop += pv.top;
                    totalPvTotal += pv.total;

                    const tRes = toretaData.reservation_count || 0;
                    const tGuest = toretaData.guest_count || 0;
                    totalReservation += tRes;
                    totalGuest += tGuest;

                    let netRes, netGuest;
                    if (mediaKey === 'tabelog') {
                        netRes = m.reservation_count_total || 0;
                        netGuest = m.guest_count_total || 0;
                    } else {
                        netRes = tRes;
                        netGuest = tGuest;
                    }

                    const noteRes = Math.max(0, tRes - netRes);
                    const noteGuest = Math.max(0, tGuest - netGuest);

                    totalNoteReservation += noteRes;
                    totalNoteGuest += noteGuest;

                    const cost = Calculations.calcTotalCost(m);
                    const revenue = tGuest * shop.avg_price_dinner;

                    totalCost += cost;
                    totalRevenue += revenue;

                    const cvr = Calculations.calcCVR(tRes, pv.top);
                    if (cvr !== null) {
                        cvrSum += cvr;
                        cvrCount++;
                    }

                    const cpg = Calculations.calcCostPerGuest(cost, tGuest);
                    if (cpg !== null) {
                        costPerGuestSum += cpg;
                        costPerGuestCount++;
                    }

                    return {
                        ym,
                        plan_name: m.plan_name || '-',
                        pv_top: pv.top,
                        pv_total: pv.total,
                        toreta_reservation: tRes,
                        toreta_guest: tGuest,
                        net_reservation: netRes,
                        net_guest: netGuest,
                        note_reservation: noteRes,
                        note_guest: noteGuest,
                        cost: cost,
                        revenue: revenue,
                        profit: revenue - cost,
                        cvr: cvr,
                        cost_per_guest: cpg
                    };
                });

                const avgCvr = cvrCount > 0 ? cvrSum / cvrCount : null;
                const avgCostPerGuest = costPerGuestCount > 0 ? Math.floor(costPerGuestSum / costPerGuestCount) : null;
                const totalProfit = totalRevenue - totalCost;

                shopData.media_analysis.push({
                    key: mediaKey,
                    name: mediaName,
                    has_plan_change: !!planChange,
                    plan_change_detail: planChange ? `${Utils.formatMonthShort(planChange.month)}: ${planChange.old} ‚Üí ${planChange.new}` : null,
                    monthly_values: monthlyValues,
                    totals: {
                        pv_top: totalPvTop,
                        pv_total: totalPvTotal,
                        toreta_reservation: totalReservation,
                        toreta_guest: totalGuest,
                        net_reservation: totalReservation - totalNoteReservation,
                        net_guest: totalGuest - totalNoteGuest,
                        note_reservation: totalNoteReservation,
                        note_guest: totalNoteGuest,
                        cost: totalCost,
                        revenue: totalRevenue,
                        profit: totalProfit,
                        cvr: avgCvr,
                        cost_per_guest: avgCostPerGuest
                    }
                });
            });

            // Â∫ÉÂëäË≤ª„Éá„Éº„Çø„ÅÆÊßãÁØâ
            shopData.ad_cost_table = this.buildAdCostTable(shop, months);

            reportData.shops.push(shopData);
        });

        return reportData;
    },

    /**
     * Â∫ÉÂëäË≤ª„ÉÜ„Éº„Éñ„É´„Éá„Éº„Çø„ÇíÊßãÁØâ
     */
    buildAdCostTable(shop, months) {
        if (!shop.ad_cost_data || shop.ad_cost_data.length === 0) {
            return null;
        }

        const mediaSet = new Set();
        shop.ad_cost_data.forEach(d => mediaSet.add(d.media));
        const mediaList = Array.from(mediaSet).sort();

        if (mediaList.length === 0) return null;

        const adCostMap = new Map(shop.ad_cost_data.map(d => [`${d.year_month}|${d.media}`, d]));
        const rows = [];
        const grandTotalByMonth = {};
        months.forEach(ym => grandTotalByMonth[ym] = 0);
        let grandTotal = 0;

        mediaList.forEach(media => {
            let mediaTotal = 0;
            let planName = '-';

            // ÊúÄÊñ∞Êúà„ÅÆ„Éó„É©„É≥Âêç„ÇíÂèñÂæó
            for (let i = months.length - 1; i >= 0; i--) {
                const ym = months[i];
                const data = adCostMap.get(`${ym}|${media}`);
                if (data && data.plan_name) {
                    planName = data.plan_name;
                    break;
                }
            }

            const monthlyCosts = {};
            months.forEach(ym => {
                const data = adCostMap.get(`${ym}|${media}`);
                const cost = data ? (data.actual_cost || data.base_cost || 0) : 0;
                monthlyCosts[ym] = cost;

                mediaTotal += cost;
                grandTotalByMonth[ym] += cost;
            });
            grandTotal += mediaTotal;

            rows.push({
                media_name: media,
                plan_name: planName,
                costs: monthlyCosts,
                total_cost: mediaTotal
            });
        });

        return {
            rows: rows,
            monthly_totals: grandTotalByMonth,
            grand_total: grandTotal
        };
    },

    /**
     * ÂÖ®‰ΩìÈõÜË®àÔºàÂâçÂπ¥ÊØîËæº„ÅøÔºâ
     */
    calcGrandTotals(shops, months, hasYoyData = false) {
        const totals = {
            monthly: {},
            grand: { sales: 0, reservation_count: 0, guest_count: 0 }
        };

        months.forEach(ym => {
            totals.monthly[ym] = { sales: 0, reservation_count: 0, guest_count: 0, uber_sales: 0 };

            shops.forEach(shop => {
                const monthlySales = shop.monthly_data.find(d => d.year_month === ym);
                const sales = monthlySales ? monthlySales.sales_amount : 0;
                totals.monthly[ym].sales += sales;
                totals.grand.sales += sales;

                const monthlyToreta = shop.toreta_data.filter(d => d.year_month === ym);
                const reservation = Calculations.calcReservationExcludingWalkinArray(monthlyToreta);
                totals.monthly[ym].reservation_count += reservation.reservation_count;
                totals.monthly[ym].guest_count += reservation.guest_count;
                totals.grand.reservation_count += reservation.reservation_count;
                totals.grand.guest_count += reservation.guest_count;

                // UberÂ£≤‰∏ä„ÅÆÂêàÁÆó„ÇíËøΩÂä†
                const uberMonth = (shop.uber_data || []).find(d => d.year_month === ym);
                totals.monthly[ym].uber_sales += (uberMonth ? (uberMonth.sales_amount || 0) : 0);
            });

            // ÂâçÂπ¥ÊØîË®àÁÆó
            if (hasYoyData) {
                const yoyMonth = ym - 100;
                let yoySales = 0, yoyReservation = 0, yoyGuest = 0;

                shops.forEach(shop => {
                    const monthlySales = shop.monthly_data.find(d => d.year_month === yoyMonth);
                    yoySales += monthlySales ? monthlySales.sales_amount : 0;

                    const monthlyToreta = shop.toreta_data.filter(d => d.year_month === yoyMonth);
                    const yoyRes = Calculations.calcReservationExcludingWalkinArray(monthlyToreta);
                    yoyReservation += yoyRes.reservation_count;
                    yoyGuest += yoyRes.guest_count;
                });

                totals.monthly[ym].sales_yoy = Calculations.calcYoY(totals.monthly[ym].sales, yoySales);
                totals.monthly[ym].reservation_yoy = Calculations.calcYoY(totals.monthly[ym].reservation_count, yoyReservation);
                totals.monthly[ym].guest_yoy = Calculations.calcYoY(totals.monthly[ym].guest_count, yoyGuest);
            }
        });

        return totals;
    },

    getMediaName(key) {
        const map = {
            'tabelog': 'È£ü„Åπ„É≠„Ç∞',
            'hotpepper': '„Éõ„ÉÉ„Éà„Éö„ÉÉ„Éë„Éº',
            'gurunavi': '„Åê„Çã„Å™„Å≥',
            'line': 'LINE',
            'conetto': '„Ç≥„Éç„ÉÉ„Éà'
        };
        return map[key] || key;
    },

    detectMediaPlanChangeArray(mediaRows, months) {
        const filtered = mediaRows.filter(r => months.includes(r.year_month)).sort((a, b) => a.year_month - b.year_month);
        for (let i = 1; i < filtered.length; i++) {
            const prev = filtered[i - 1];
            const curr = filtered[i];
            if (prev.plan_name && curr.plan_name && prev.plan_name !== curr.plan_name) {
                return { month: curr.year_month, old: prev.plan_name, new: curr.plan_name };
            }
        }
        return null;
    }
};


// --- main.js ---
// ============================================
// Vue.js Application Entry Point
// ============================================

const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

// ÂàùÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åô„ÇãÂ§âÊï∞Ôºà„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÁî®Ôºâ
let initialAppTemplate = '';

const app = createApp({
    setup() {
        // --- State ---
        const step = ref(1); // 1: Input, 2: Settings, 3: Report
        const isLoading = ref(false);
        const loadingText = ref('Ë™≠„ÅøËæº„Åø‰∏≠...');
        const rawData = ref(null);      // Parsed TOON Object
        const reportData = ref(null);   // Data formatted for View
        const isDragging = ref(false);

        // Settings
        const periodStart = ref(null);
        const periodEnd = ref(null);
        const availableShops = ref([]); // { code: string, name: string }[]
        const selectedShops = ref([]); // shop_code[]
        const aiEnabled = ref(false); // Global AI toggle

        // UI State
        const openShopCode = ref(null); // Accordion state
        const othersOpen = ref({}); // { shop_code: boolean }

        // AI Feature
        const aiSummary = ref({ content: '', loading: false, error: null });
        const aiShopComments = ref({}); // { shop_code: { content: '', loading: false, error: null } }

        // --- Computed ---
        const hasData = computed(() => !!reportData.value && step.value === 3);
        const hasRawData = computed(() => !!rawData.value);

        // --- Methods ---

        // File Handling
        const handleDrop = async (e) => {
            e.preventDefault();
            isDragging.value = false;
            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        };

        const handleFileSelect = (e) => {
            const files = e.target.files;
            if (files.length > 0) processFile(files[0]);
        };

        const processFile = (file) => {
            isLoading.value = true;
            loadingText.value = '„Éï„Ç°„Ç§„É´„ÇíËß£Êûê‰∏≠...';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    const parser = new ToonParser();
                    const parsed = parser.parse(content);

                    console.log('Parsed Data:', parsed);
                    rawData.value = parsed;

                    // Initial Setup from parsed data
                    initializeOptions(parsed);

                    // Move to Settings Step
                    step.value = 2;

                    isLoading.value = false;
                } catch (err) {
                    console.error(err);
                    alert('„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
                    isLoading.value = false;
                }
            };
            reader.readAsText(file);
        };

        const initializeOptions = (data) => {
            // Set Period
            if (data.export_info.period) {
                // Âçò‰∏Ä„ÅÆÊúüÈñì„ÅåÂÖ•„Å£„Å¶„ÅÑ„ÇãÂâçÊèê (TOON„ÅÆ‰ªïÊßò„Å´„Çà„Çã)
                periodStart.value = data.export_info.period.start;
                periodEnd.value = data.export_info.period.end;
            }

            // Set Shops
            if (data.shops && data.shops.length > 0) {
                availableShops.value = data.shops.map(s => ({
                    code: s.shop_code,
                    name: s.shop_name
                }));
                // Default: Select All
                selectedShops.value = data.shops.map(s => s.shop_code);
            }
        };

        const generateReport = async () => {
            console.log('Generating report...');
            if (!rawData.value) return;

            isLoading.value = true;
            loadingText.value = '„É¨„Éù„Éº„Éà„ÇíÁîüÊàê‰∏≠...';

            try {
                // Short wait to update UI state
                await new Promise(resolve => setTimeout(resolve, 100));

                // Use DataBuilder to transform data
                const result = DataBuilder.build(
                    rawData.value,
                    Number(periodStart.value),
                    Number(periodEnd.value),
                    selectedShops.value
                );

                console.log('Report Data:', result);
                reportData.value = result;

                // Reset UI state for report
                openShopCode.value = null;
                aiSummary.value = { content: '', loading: false, error: null };
                aiShopComments.value = {};

                // Move to Report Step
                step.value = 3;

                // Trigger AI if enabled (Simulate GAS call trigger)
                if (aiEnabled.value) {
                    fetchAiSummary();
                }
            } catch (err) {
                console.error(err);
                alert('„É¨„Éù„Éº„ÉàÁîüÊàê„Ç®„É©„Éº: ' + err.message);
            } finally {
                isLoading.value = false;
            }
        };

        const backToSettings = () => {
            step.value = 2;
        };

        const resetAll = () => {
            rawData.value = null;
            reportData.value = null;
            availableShops.value = [];
            selectedShops.value = [];
            step.value = 1;
            openShopCode.value = null; // Reset open shop code
            aiShopComments.value = {}; // Reset AI shop comments
        };

        const toggleShop = (shopCode) => {
            if (openShopCode.value === shopCode) {
                openShopCode.value = null;
            } else {
                openShopCode.value = shopCode;
                // Render charts when opening
                const shop = reportData.value.shops.find(s => s.shop_code === shopCode);
                if (shop) {
                    setTimeout(() => {
                        // Channel Colors Map
                        const colors = {};
                        shop.channel_data.forEach(ch => {
                            colors[ch.channel_name] = getChannelColor(ch.channel_name);
                        });
                        ChartRenderer.renderShopCharts(shop, colors);
                    }, 0);
                }
            }
        };

        const closeShop = () => {
            openShopCode.value = null;
        };

        const toggleOthers = (shopCode) => {
            othersOpen.value[shopCode] = !othersOpen.value[shopCode];
        };

        const getOthersBreakdown = (shop) => {
            const othersChannel = shop.channel_data.find(ch => ch.channel_name === '„Åù„ÅÆ‰ªñ');
            if (othersChannel && othersChannel.breakdown) {
                return othersChannel.breakdown; // Êó¢„Å´„ÇΩ„Éº„ÉàÊ∏à„Åø
            }
            return [];
        };

        const formatOthersCount = (shop, ym, otherName) => {
            const othersChannel = shop.channel_data.find(ch => ch.channel_name === '„Åù„ÅÆ‰ªñ');
            if (!othersChannel) return '-';
            const monthData = othersChannel.monthly_data.find(d => d.ym === ym);
            if (!monthData) return '-';

            // Note: monthly_data„Å´„ÅØÂêàË®àÂÄ§„Åó„ÅãÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅutils.js„Åß„ÅÆÈõÜË®àÊôÇ„Å´„Éñ„É¨„Éº„ÇØ„ÉÄ„Ç¶„É≥„Åî„Å®„ÅÆÊúàÊ¨°„Éá„Éº„Çø„ÇÇ‰øùÊåÅ„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„Åå„ÄÅ
            // ÁèæÁä∂„ÅÆÊßãÈÄ†Á∂≠ÊåÅ„ÅÆ„Åü„ÇÅ„ÄÅÁ∞°ÊòìÁöÑ„Å´ÂÖÉ„Éá„Éº„Çø(shop.toreta_data)„Åã„ÇâÂèñÂæó„Åô„Çã
            const toretaMonth = shop.raw_toreta_data[ym];
            if (!toretaMonth) return '-';

            const count = toretaMonth[otherName]?.reservation_count || 0;
            return count > 0 ? `${formatNumber(count)}ÁµÑ` : '-';
        };

        const formatOthersTotal = (shop, otherName) => {
            // Á∞°ÊòìË®àÁÆó: ÂÖ®Êúà„ÅÆÂêàË®à
            let total = 0;
            const months = Utils.getMonthsInRange(reportData.value.period.start, reportData.value.period.end);
            months.forEach(ym => {
                const toretaMonth = shop.raw_toreta_data[ym];
                if (toretaMonth) {
                    total += toretaMonth[otherName]?.reservation_count || 0;
                }
            });
            return total > 0 ? `${formatNumber(total)}ÁµÑ` : '-';
        };

        const sortedChannelData = (channelData) => {
            // „Åù„ÅÆ‰ªñ„Çí‰∏ÄÁï™‰∏ã„Å´ÁßªÂãï
            const normal = channelData.filter(ch => ch.channel_name !== '„Åù„ÅÆ‰ªñ');
            const others = channelData.filter(ch => ch.channel_name === '„Åù„ÅÆ‰ªñ');
            return [...normal, ...others];
        };

        const getShopName = (code) => {
            if (!code || !reportData.value) return '';
            const shop = reportData.value.shops.find(s => s.shop_code === code);
            return shop ? shop.shop_name : '';
        };

        const toggleAllShops = () => {
            if (selectedShops.value.length === availableShops.value.length) {
                selectedShops.value = [];
            } else {
                selectedShops.value = availableShops.value.map(s => s.code);
            }
        };

        const renderCharts = (shopCode) => {
            const shop = reportData.value.shops.find(s => s.shop_code === shopCode);
            if (shop) {
                // Channel Colors Map
                const colors = {};
                shop.channel_data.forEach(ch => {
                    colors[ch.channel_name] = getChannelColor(ch.channel_name);
                });

                // Use ChartRenderer
                ChartRenderer.renderShopCharts(shop, colors);
            }
        };

        // --- Restore Data (for Downloaded Report) ---
        onMounted(() => {
            // ÂàùÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠òÔºàVue„ÅåDOM„ÇíÊõ∏„ÅçÊèõ„Åà„ÇãÂâç...„Å®Ë®Ä„ÅÑ„Åü„ÅÑ„Åå„ÄÅ
            // app.mount„ÅåÂëº„Å∞„Çå„ÇãÂâç„Å™„ÇâÂèñ„Çå„Çã„ÅØ„Åö„Å†„Åå„ÄÅcreateAppÂÜÖ„Å™„ÅÆ„Åß„Çø„Ç§„Éü„É≥„Ç∞„ÅåÂæÆÂ¶ô„ÄÇ
            // Á¢∫ÂÆü„Å™„ÅÆ„ÅØ app.mount „ÅÆÁõ¥Ââç„ÅßÂèñÂæó„Åó„Å¶„ÄÅdownloadReport„Åã„ÇâÂèÇÁÖß„Åô„Çã„Åì„Å®„ÄÇ
            // „Åì„Åì„Åß„ÅØ„Éá„Éº„ÇøÂæ©ÂÖÉ„ÅÆ„ÅøË°å„ÅÜ„ÄÇ

            if (window.__PRELOADED_DATA__) {
                console.log('üíæ „É™„Çπ„Éà„Ç¢„Éá„Éº„Çø„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü„ÄÇ„É¨„Éù„Éº„Éà„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô...');
                const data = window.__PRELOADED_DATA__;

                // „Éá„Éº„Çø„ÅÆÂæ©ÂÖÉ
                if (data.reportData) {
                    reportData.value = data.reportData;
                    step.value = 3;
                }

                if (data.settings) {
                    periodStart.value = data.settings.periodStart;
                    periodEnd.value = data.settings.periodEnd;
                    selectedShops.value = data.settings.selectedShops;
                    aiEnabled.value = data.settings.aiEnabled;
                }

                // AIÂàÜÊûêÁµêÊûú„ÅÆÂæ©ÂÖÉÔºà„ÅÇ„Çå„Å∞Ôºâ
                if (data.aiSummary) aiSummary.value = data.aiSummary;
                if (data.aiShopComments) aiShopComments.value = data.aiShopComments;

                // RawDataÂæ©ÂÖÉÔºàÂÜçË®àÁÆóÁî®Ôºâ
                if (data.rawData) {
                    rawData.value = data.rawData;
                    // availableShopsÁ≠â„ÅÆÂæ©ÂÖÉ
                    if (data.rawData.shops) {
                        availableShops.value = data.rawData.shops.map(s => ({
                            code: s.shop_code,
                            name: s.shop_name
                        }));
                    }
                }
            }
        });

        // --- AI Features ---
        const fetchAiSummary = () => {
            if (!hasData.value) return;

            aiSummary.value.loading = true;
            aiSummary.value.error = null;

            // Prepare data for GAS
            // We need to pass raw structured data, not the massive strings if possible, 
            // but current logic expects built text.
            // For now, let's call GAS function (mocked locally, real in GAS).

            if (typeof google !== 'undefined' && google.script) {
                const summaryData = {
                    period: reportData.value.period,
                    shops: reportData.value.shops, // This is quite large, might hit limits if not careful
                    grandTotals: reportData.value.grandTotals
                };

                google.script.run
                    .withSuccessHandler(result => {
                        aiSummary.value.content = result;
                        aiSummary.value.loading = false;
                    })
                    .withFailureHandler(error => {
                        aiSummary.value.error = error.message;
                        aiSummary.value.loading = false;
                    })
                    .getAiSummaryComment(summaryData);
            } else {
                // Local Mock
                setTimeout(() => {
                    aiSummary.value.content = "„ÄêAIÂàÜÊûê„Éó„É¨„Éì„É•„Éº„Äë\n„Åì„Çå„ÅØ„É≠„Éº„Ç´„É´Áí∞Â¢ÉÁî®„ÅÆ„ÉÄ„Éü„Éº„ÉÜ„Ç≠„Çπ„Éà„Åß„Åô„ÄÇ\nÂÆüÈöõ„ÅÆÁí∞Â¢É„Åß„ÅØGemini AI„Å´„Çà„ÇãÂàÜÊûêÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ";
                    aiSummary.value.loading = false;
                }, 1500);
            }
        };

        const fetchAiShopComment = (shop) => {
            if (!shop) return;

            // Init state for this shop
            aiShopComments.value[shop.shop_code] = { content: '', loading: true, error: null };

            if (typeof google !== 'undefined' && google.script) {
                const avgSales = reportData.value.grandTotals.grand.sales / reportData.value.shops.length;

                google.script.run
                    .withSuccessHandler(result => {
                        aiShopComments.value[shop.shop_code] = { content: result, loading: false, error: null };
                    })
                    .withFailureHandler(error => {
                        aiShopComments.value[shop.shop_code] = { content: '', loading: false, error: error.message };
                    })
                    .getAiShopComment(shop, avgSales);
            } else {
                // Local Mock
                setTimeout(() => {
                    aiShopComments.value[shop.shop_code] = {
                        content: `„Äê${shop.shop_name} ÂàÜÊûê„Äë\nÂ£≤‰∏ä„ÅØÂ•ΩË™ø„Å´Êé®Áßª„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ‰∫àÁ¥ÑÁµåË∑Ø„ÅØÈ£ü„Åπ„É≠„Ç∞„Åå‰∏ªË¶Å„Åß„Åô„ÄÇ`,
                        loading: false,
                        error: null
                    };
                }, 1000);
            }
        };

        // Watch for checkbox change
        watch(aiEnabled, (newVal) => {
            if (newVal && hasData.value && !aiSummary.value.content && !aiSummary.value.loading) {
                fetchAiSummary();
            }
        });

        // --- Utils Exposure ---
        const formatCurrency = Utils.formatCurrency;
        const formatNumber = Utils.formatNumber;
        const formatPercent = Utils.formatPercent;
        const getProfitClass = Calculations.getProfitClass;
        const getYoYClass = Calculations.getYoYClass;

        const getChannelColor = (name) => {
            const colors = {
                'ÈõªË©±': '#4CAF50',
                '„Éà„É¨„Çø‰∫àÁ¥ÑÁï™': '#00BCD4',
                'È£ü„Åπ„É≠„Ç∞': '#FF6B00',
                '„Éõ„ÉÉ„Éà„Éö„ÉÉ„Éë„Éº': '#E60012',
                'Retty': '#FF5722',
                '‰∏Ä‰ºë': '#1A1A1A',
                'OZmall': '#E91E63',
                '„Åê„Çã„Å™„Å≥': '#B50000',
                'Google„Åß‰∫àÁ¥Ñ': '#4285F4',
                '„Åã„Çì„Åü„Çì„Éç„ÉÉ„Éà‰∫àÁ¥Ñ': '#9C27B0',
                '„Åã„Çì„Åü„Çì„Éç„ÉÉ„Éà‰∫àÁ¥Ñ„Éó„É©„Çπ': '#7B1FA2',
                'PayPay„Ç∞„É´„É°': '#FF0033',
                'LINE': '#06C755',
                '„Åù„ÅÆ‰ªñ': '#9E9E9E'
            };
            return colors[name] || '#9E9E9E';
        };

        // --- Download Feature ---
        // --- Download Feature ---
        const downloadReport = () => {
            if (!reportData.value) return;

            // 1. ‰øùÂ≠ò„Åô„Çã„Éá„Éº„Çø„ÇíÊ∫ñÂÇô
            const saveData = {
                reportData: reportData.value,
                rawData: rawData.value,
                settings: {
                    periodStart: periodStart.value,
                    periodEnd: periodEnd.value,
                    selectedShops: selectedShops.value,
                    aiEnabled: aiEnabled.value
                },
                aiSummary: aiSummary.value,
                aiShopComments: aiShopComments.value
            };

            // 2. ÁèæÂú®„ÅÆDOM„ÅÆÁä∂ÊÖã„Åß„ÅØ„Å™„Åè„ÄÅ„Ç¢„Éó„É™Ëµ∑ÂãïÁõ¥Âæå„ÅÆ„ÇØ„É™„Éº„É≥„Å™Áä∂ÊÖã„ÅÆHTMLÊßãÈÄ†„ÇíÂÜçÁèæ„Åô„Çã
            // document.documentElement.outerHTML „Çí‰Ωø„ÅÜ„Å®„ÄÅÁèæÂú®„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞Ê∏à„ÅøÔºàv-forÂ±ïÈñãÊ∏à„ÅøÔºâ„ÅÆDOM„ÅåÂèñ„Çå„Å¶„Åó„Åæ„ÅÑ„ÄÅ
            // ÂÜçÂ∫¶Vue„Åå„Éû„Ç¶„É≥„Éà„Åó„Åü„Å®„Åç„Å´‰∫åÈáç„É¨„É≥„ÉÄ„É™„É≥„Ç∞Á≠â„ÅÆÂïèÈ°å„ÅåËµ∑„Åç„Çã„ÄÇ
            // „Åù„ÅÆ„Åü„ÇÅ„ÄÅ‰øùÂ≠ò„Åó„Å¶„Åä„ÅÑ„Åü initialAppTemplate „Çí‰Ωø„Å£„Å¶ #app „ÅÆ‰∏≠Ë∫´„ÇíÊõ∏„ÅçÊèõ„Åà„Çã„ÄÇ

            // HTMLÂÖ®‰Ωì„ÇíÂèñÂæó
            const doc = document.documentElement.cloneNode(true);

            // #app „ÅÆ‰∏≠Ë∫´„ÇíÂàùÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å´Êàª„Åô
            const appDiv = doc.querySelector('#app');
            if (appDiv && initialAppTemplate) {
                appDiv.innerHTML = initialAppTemplate;
            }

            // 3. Âæ©ÂÖÉÁî®„Éá„Éº„Çø„ÇíÊ≥®ÂÖ•
            // „Ç®„Çπ„Ç±„Éº„ÉóÂá¶ÁêÜÔºöJSONÂÜÖ„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„Çø„Ç∞Èñâ„Åò„ÇíÈò≤Ê≠¢
            // Unicode„Ç®„Çπ„Ç±„Éº„Éó„ÅßÊ≠£Ë¶èË°®Áèæ„Çí‰ΩúÊàêÔºà„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Å´ < / s c r i p t > „ÇíÂá∫Áèæ„Åï„Åõ„Å™„ÅÑÔºâ
            const scriptCloseRegex = new RegExp('\u003c/script\u003e', 'g');
            const jsonStr = JSON.stringify(saveData).replace(scriptCloseRegex, '\\u003c/script\\u003e');

            const dataScript = document.createElement('script');
            dataScript.textContent = `window.__PRELOADED_DATA__ = ${jsonStr};`;

            // ÈáçË¶ÅÔºöVue„Åå„Éû„Ç¶„É≥„Éà„Åï„Çå„ÇãÂâç„Å´„Éá„Éº„Çø„ÇíÂÆöÁæ©„Åó„Å¶„Åä„ÅèÂøÖË¶Å„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ
            // body„ÅÆÊú´Â∞æ„Åß„ÅØ„Å™„Åè„ÄÅhead„ÅÆÊú´Â∞æÔºàCSS„ÅÆÂæå„ÄÅ„É°„Ç§„É≥„Çπ„ÇØ„É™„Éó„Éà„ÅÆÂâç„ÅÇ„Åü„ÇäÔºâ„Å´ËøΩÂä†„Åô„Çã
            // „ÅÇ„Çã„ÅÑ„ÅØ body „ÅÆÂÖàÈ†≠„Åß„ÇÇËâØ„ÅÑ
            const head = doc.querySelector('head');
            head.appendChild(dataScript);

            // 4. HTMLÊñáÂ≠óÂàóÂåñ„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            // GAS/„Éñ„É©„Ç¶„Ç∂„ÅÆ„Éë„Éº„Çµ„ÉºÂØæÁ≠ñ„Å®„Åó„Å¶„ÄÅHTML„Çø„Ç∞„ÇíÂê´„ÇÄÊñáÂ≠óÂàó„ÇíÁõ¥Êé•„Ç≥„Éº„Éâ„Å´Êõ∏„Åã„Å™„ÅÑ
            // Unicode„Ç®„Çπ„Ç±„Éº„Éó„Çí‰ΩøÁî®„Åó„Å¶„Çø„Ç∞„ÇíË°®Áèæ
            const doctype = '\u003c!DOCTYPE html\u003e\n';
            const htmlClose = '\u003c/html\u003e';

            // outerHTML„Å´„ÅØ </html> „ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„ÇãÔºàdocumentElement.outerHTML„ÅØÂê´„ÇÄ„ÅØ„Åö„Å†„ÅåÂøµ„ÅÆ„Åü„ÇÅÔºâ
            // ÂÆâÂÖ®„ÅÆ„Åü„ÇÅ„ÄÅdoc.outerHTML „Çí‰Ωø„ÅÜ
            const fullHTML = doctype + doc.outerHTML;

            const blob = new Blob([fullHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Â∫óËàóÂàÜÊûê„É¨„Éù„Éº„Éà_${reportData.value.period.start}-${reportData.value.period.end}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        return {
            step,
            isLoading,
            loadingText,
            handleDrop,
            handleFileSelect,
            isDragging,
            hasData,
            reportData,

            // Settings
            aiEnabled,
            periodStart,
            periodEnd,
            availableShops,
            selectedShops,
            generateReport,
            backToSettings,
            resetAll,
            Object,

            // Actions
            toggleAllShops,
            downloadReport,

            // UI State
            openShopCode,
            toggleShop,
            closeShop,

            // Others Toggle
            othersOpen,
            toggleOthers,
            getOthersBreakdown,
            formatOthersCount,
            formatOthersTotal,
            sortedChannelData,
            getShopName,

            // AI
            aiSummary,
            aiShopComments,
            fetchAiShopComment,

            // Utils
            formatCurrency,
            formatNumber,
            formatPercent,
            getProfitClass,
            getYoYClass,
            getChannelColor,
            Utils
        };
    }
});

// „Éû„Ç¶„É≥„ÉàÁõ¥Ââç„Å´ÂàùÊúü„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÁ¢∫‰øù
// „Åì„Çå„Å´„Çà„Çä„ÄÅ„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÊôÇ„Å´„ÄåVueÊú™ÈÅ©Áî®„ÅÆ„Åç„Çå„ÅÑ„Å™HTML„Äç„Å™„Å©„Çí‰Ωø„Å£„Å¶„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê„Åß„Åç„Çã
const appElement = document.getElementById('app');
if (appElement) {
    initialAppTemplate = appElement.innerHTML;
}

app.mount('#app');



</script>